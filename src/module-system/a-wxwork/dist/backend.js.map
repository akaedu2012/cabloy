{"version":3,"file":"backend.js","mappings":";;;;;;AAAA,iBAAiB,mBAAO,CAAC,GAAU;AACnC;AACA;AACA;AACA;;AAEA;AACA;AACA,QAAQ;AACR;AACA;AACA;AACA;AACA;AACA;AACA,gBAAgB;AAChB;AACA;AACA;AACA;AACA;AACA;AACA,0BAA0B;AAC1B;AACA;AACA;AACA,gEAAgE,2BAA2B;AAC3F;AACA;AACA,2BAA2B;AAC3B;AACA;AACA,sBAAsB;AACtB;AACA,wDAAwD,eAAe;AACvE;AACA;AACA;AACA,iBAAiB;AACjB;AACA;AACA,YAAY;AACZ;AACA;AACA,gBAAgB;AAChB;AACA;AACA;AACA,uDAAuD,kBAAkB;AACzE;AACA;AACA,iBAAiB;AACjB;AACA;AACA,YAAY;AACZ;AACA;AACA;AACA;AACA,SAAS;AACT;AACA;AACA;;AAEA,iCAAiC,eAAe;AAChD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,yCAAyC,cAAc;AACvD;AACA,OAAO;AACP;AACA,yCAAyC,cAAc;AACvD;AACA;AACA,UAAU;AACV;AACA;AACA;AACA;AACA;AACA;AACA;AACA,4CAA4C,QAAQ,GAAG,KAAK;AAC5D;AACA,OAAO;AACP;AACA,4CAA4C,QAAQ,GAAG,KAAK;AAC5D;AACA;AACA,UAAU;AACV;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,kCAAkC,YAAY;AAC9C;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,6CAA6C,WAAW;AACxD;AACA,OAAO;AACP;AACA,6CAA6C,WAAW;AACxD;AACA;AACA,UAAU;AACV;AACA;AACA;AACA;AACA;AACA;AACA;AACA,gDAAgD,WAAW,GAAG,KAAK;AACnE;AACA,OAAO;AACP;AACA,gDAAgD,WAAW,GAAG,KAAK;AACnE;AACA;AACA,UAAU;AACV;AACA;AACA;AACA;AACA;AACA;AACA;AACA,kDAAkD,WAAW,GAAG,wBAAwB;AACxF;AACA,OAAO;AACP;AACA,kDAAkD,WAAW,GAAG,wBAAwB;AACxF;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAAO;AACP;AACA;AACA;;;;;;;;AChLA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;;;;;;;ACjBA,iBAAiB,mBAAO,CAAC,GAAU;AACnC;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,qBAAqB;AACrB,SAAS;AACT;AACA;AACA;AACA;AACA;;AAEA;AACA;;;;;;;;ACnBA;AACA;AACA;AACA,mBAAmB,0DAA0D;AAC7E;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,mBAAmB,iBAAiB;AACpC;AACA,SAAS;AACT;AACA;AACA;AACA;AACA;AACA;AACA,mBAAmB,iBAAiB;AACpC;AACA,SAAS;AACT;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;ACvCA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;ACVA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,QAAQ;AACR;AACA;AACA;AACA;;AAEA;AACA;;;;;;;;ACdA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;;AAEA;AACA;;;;;;;;ACtEA,uBAAuB,mBAAO,CAAC,GAA2B;AAC1D,uBAAuB,mBAAO,CAAC,GAA2B;AAC1D,8BAA8B,mBAAO,CAAC,GAAkC;AACxE,sBAAsB,mBAAO,CAAC,GAA0B;AACxD,2BAA2B,mBAAO,CAAC,EAA+B;AAClE,qBAAqB,mBAAO,CAAC,GAA0B;AACvD,mBAAmB,mBAAO,CAAC,GAAuB;;AAElD;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL;AACA;AACA;AACA;AACA,KAAK;AACL;AACA;AACA;AACA,KAAK;AACL;AACA;AACA;AACA;AACA,KAAK;AACL;AACA;AACA;AACA;AACA,KAAK;AACL;AACA;AACA;AACA;AACA,KAAK;AACL;AACA;AACA;AACA;AACA;AACA,KAAK;AACL;AACA;AACA;;;;;;;;AC/CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;AACH;AACA;AACA;AACA;AACA;AACA,GAAG;AACH;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,kBAAkB,YAAY,IAAI,gCAAgC;AAClE;AACA;AACA;AACA;AACA,GAAG;AACH;;;;;;;;AC5CA,eAAe,mBAAO,CAAC,GAAQ;AAC/B,iBAAiB,mBAAO,CAAC,GAAU;AACnC;AACA;;AAEA;AACA;AACA;AACA,GAAG;AACH;AACA;AACA,GAAG;AACH,kBAAkB,mCAAmC;AACrD;AACA;AACA;AACA,GAAG;AACH,mBAAmB,+DAA+D;AAClF,uCAAuC,mCAAmC;AAC1E;AACA;AACA,KAAK;AACL,GAAG;AACH,aAAa,sDAAsD;AACnE,gCAAgC,2BAA2B;AAC3D,GAAG;AACH;;;;;;;;AC1BA,iBAAiB,mBAAO,CAAC,GAAU;AACnC;AACA;AACA,2BAA2B,mBAAO,CAAC,GAAyB;;AAE5D;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,2BAA2B,4DAA4D;AACvF;AACA;AACA,mDAAmD,UAAU;AAC7D;AACA;AACA;AACA,uDAAuD,0CAA0C;AACjG;AACA;AACA;AACA,kDAAkD,oBAAoB;AACtE;AACA;AACA;AACA,QAAQ;AACR;AACA;AACA,SAAS;AACT;AACA;AACA;AACA;;AAEA,iCAAiC,UAAU;AAC3C;AACA;AACA,qCAAqC,UAAU;AAC/C;;AAEA;AACA,4BAA4B,yBAAyB;AACrD;AACA;AACA;AACA;AACA;AACA;AACA,kCAAkC,SAAS;AAC3C;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAAS;AACT;AACA;AACA;AACA;AACA;AACA;AACA,OAAO;AACP;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,wCAAwC;AACxC;AACA;AACA;AACA;AACA;AACA;AACA,SAAS;AACT;AACA,QAAQ;AACR;AACA,wCAAwC;AACxC;AACA;AACA;AACA;AACA;AACA;AACA,SAAS;AACT;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,iCAAiC,uCAAuC;AACxE;AACA;AACA;AACA;AACA;;AAEA;AACA;;;;;;;;ACzHA,kBAAkB,mBAAO,CAAC,GAAuB;AACjD,uBAAuB,mBAAO,CAAC,GAA4B;;AAE3D;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL;;AAEA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,WAAW;AACX,SAAS;AACT;AACA;AACA;AACA,SAAS;AACT;AACA;AACA,SAAS;AACT,OAAO;AACP;AACA;AACA;AACA;AACA,OAAO;AACP,KAAK;AACL;AACA;AACA;AACA;AACA;AACA;AACA,OAAO;AACP,KAAK;AACL;;AAEA;AACA;AACA;AACA;AACA;AACA,OAAO;AACP,uBAAuB;AACvB,KAAK;AACL;;AAEA;AACA;;;;;;;;ACzFA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;ACrDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;ACnDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;ACVA;AACA;AACA;AACA;;;;;;;;ACHA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;ACnBA;AACA,WAAW,mBAAO,CAAC,GAAmB;AACtC,WAAW,mBAAO,CAAC,EAAmB;AACtC;;;;;;;;ACHA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL;AACA;AACA;;;;;;;;ACRA;AACA;AACA;AACA;AACA;AACA,KAAK;AACL;AACA;AACA;;;;;;;;ACRA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,WAAW;AACX,SAAS;AACT,OAAO;AACP;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,aAAa;AACb,WAAW;AACX,SAAS;AACT,OAAO;AACP,KAAK;AACL;;AAEA;AACA;;;;;;;;ACtCA;AACA;AACA;AACA;AACA;AACA;AACA,OAAO;AACP;AACA;AACA;AACA;AACA;;;;;;;;ACXA,iBAAiB,mBAAO,CAAC,GAAU;AACnC;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAAS;AACT,OAAO;AACP,yBAAyB,YAAY;AACrC;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;AC/BA;AACA;AACA;AACA;AACA;AACA,OAAO;AACP;AACA;;AAEA;AACA;AACA;AACA,OAAO;AACP;AACA;AACA;AACA;AACA;;;;;;;;ACjBA,iBAAiB,mBAAO,CAAC,GAAU;AACnC;AACA,oBAAoB,mBAAO,CAAC,GAA0B;;AAEtD;AACA;AACA;AACA,sDAAsD,SAAS;AAC/D,sDAAsD,SAAS;AAC/D,OAAO;AACP;;AAEA;AACA,qDAAqD,SAAS;AAC9D,yDAAyD,SAAS;AAClE,OAAO;AACP;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,8BAA8B;AAC9B;AACA;AACA;AACA;AACA;AACA;AACA;AACA,kDAAkD,2CAA2C;AAC7F;AACA;AACA;AACA;AACA,QAAQ;AACR,mDAAmD,2CAA2C;AAC9F;AACA;AACA,2CAA2C,oBAAoB;AAC/D;AACA;AACA,UAAU;AACV,0CAA0C,iBAAiB;AAC3D;AACA;AACA;AACA;AACA;AACA;AACA,4CAA4C,WAAW;AACvD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,6BAA6B,2CAA2C;AACxE;AACA;AACA;AACA;AACA,QAAQ;AACR;AACA;AACA,sCAAsC,iEAAiE;AACvG;AACA;AACA;AACA;AACA;AACA,iBAAiB;AACjB;AACA,eAAe;AACf;;AAEA,8BAA8B,2CAA2C;AACzE;AACA;AACA;AACA;AACA,QAAQ;AACR;AACA;AACA;AACA;AACA,6CAA6C,aAAa;AAC1D;AACA;AACA;AACA;AACA,QAAQ;AACR;AACA;AACA,sCAAsC,iEAAiE;AACvG;AACA;AACA;AACA;AACA;AACA,2CAA2C,kBAAkB;AAC7D;AACA;AACA;AACA;AACA;AACA;;;;;;;;AChHA,gBAAgB,mBAAO,CAAC,GAAyB;AACjD,iBAAiB,mBAAO,CAAC,EAA0B;;AAEnD,cAAc,mBAAO,CAAC,GAAuB;AAC7C,iBAAiB,mBAAO,CAAC,GAA0B;;AAEnD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;ACdA,eAAe,mBAAO,CAAC,EAAoB;AAC3C,gBAAgB,mBAAO,CAAC,EAAqB;AAC7C,eAAe,mBAAO,CAAC,GAAoB;;AAE3C;AACA;AACA,gBAAgB,mBAAO,CAAC,GAAY;AACpC;AACA,iBAAiB,mBAAO,CAAC,GAAa;AACtC;AACA,sBAAsB,mBAAO,CAAC,EAAkB;AAChD;AACA,mBAAmB,mBAAO,CAAC,GAAe;AAC1C;AACA,iBAAiB,mBAAO,CAAC,GAAa;AACtC;AACA,eAAe,mBAAO,CAAC,GAAW;;AAElC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;AC7BA,eAAe,mBAAO,CAAC,GAAoB;;AAE3C;AACA,kBAAkB,mBAAO,CAAC,GAAgC;AAC1D;AACA,kCAAkC,mBAAO,CAAC,GAAsC;AAChF,6BAA6B,mBAAO,CAAC,GAAiC;AACtE;AACA;AACA,eAAe;AACf,KAAK;AACL;AACA;AACA;AACA;AACA,SAAS;AACT,OAAO;AACP,kBAAkB;AAClB;AACA;AACA,OAAO;AACP,KAAK;AACL;AACA;AACA;AACA,OAAO;AACP,KAAK;AACL;AACA;AACA;AACA,OAAO;AACP;AACA;AACA;AACA,OAAO;AACP,KAAK;AACL;AACA;AACA;AACA,OAAO;AACP;AACA;AACA,OAAO;AACP,KAAK;AACL;AACA;AACA;AACA;;;;;;;;AC/CA;AACA;AACA;AACA,mBAAmB,uCAAuC,wBAAwB;AAClF;AACA;AACA;AACA;;;;;;;;ACPA;AACA;AACA;AACA,mBAAmB,mCAAmC,yBAAyB;AAC/E;AACA;AACA;AACA;;;;;;;;ACPA,mBAAmB,mBAAO,CAAC,GAAuB;AAClD,eAAe,mBAAO,CAAC,GAAmB;;AAE1C;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;ACTA,iBAAiB,mBAAO,CAAC,GAAsB;AAC/C,uBAAuB,mBAAO,CAAC,GAA2B;AAC1D,2BAA2B,mBAAO,CAAC,GAAiC;;AAEpE;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,4BAA4B,uBAAuB;AACnD,OAAO;AACP;AACA;AACA;AACA,OAAO;AACP;AACA;AACA;AACA,mBAAmB;AACnB,SAAS;AACT,OAAO;AACP;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,qBAAqB;AACrB,mBAAmB;AACnB;AACA;AACA,mBAAmB;AACnB;AACA,eAAe;AACf;AACA,WAAW;AACX;AACA,OAAO;AACP;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAAO;AACP,gBAAgB;AAChB;AACA;AACA;;AAEA;AACA,iBAAiB;AACjB;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,+BAA+B,WAAW;AAC1C;AACA;AACA;;AAEA;AACA;AACA;;;;;;;;AChGA,iBAAiB,mBAAO,CAAC,GAAU;AACnC;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;;;;;;;;ACjCA,iBAAiB,mBAAO,CAAC,GAAU;AACnC;AACA;AACA,cAAc,mBAAO,CAAC,GAAY;;AAElC;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;;AAEA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA,QAAQ;AACR;AACA;AACA,MAAM;AACN;AACA;AACA,IAAI;AACJ;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;;;;;;;;AC/FA;AACA;AACA;AACA,MAAM,qEAAqE,QAAQ,mBAAmB;AACtG,MAAM,sEAAsE,QAAQ,mBAAmB;AACvG,MAAM,wEAAwE,QAAQ,mBAAmB;AACzG,MAAM,yEAAyE,QAAQ,mBAAmB;AAC1G;AACA;AACA;AACA;AACA;AACA,cAAc,SAAS,4DAA4D;AACnF,KAAK;AACL;AACA;AACA;AACA;AACA,cAAc,SAAS,4DAA4D;AACnF,KAAK;;AAEL;AACA,MAAM,6DAA6D;AACnE,MAAM,kEAAkE;;AAExE;AACA,MAAM,gEAAgE;AACtE;AACA;AACA;;;;;;;;AC7BA,uBAAuB,mBAAO,CAAC,GAA2B;;AAE1D;AACA;AACA,kBAAkB,aAAa;AAC/B;AACA;AACA,uBAAuB;AACvB;AACA;AACA;AACA;AACA;AACA,0CAA0C,oBAAoB,MAAM,aAAa;AACjF;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;;;;;;;ACtBA,uBAAuB,mBAAO,CAAC,GAA2B;;AAE1D;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,eAAe;AACf;;AAEA,sBAAsB,0BAA0B;AAChD;AACA,2CAA2C,oBAAoB;AAC/D,QAAQ;AACR,uCAAuC,oBAAoB;AAC3D;AACA;;AAEA,+BAA+B,SAAS;AACxC;AACA;AACA;AACA,mDAAmD,SAAS;AAC5D,QAAQ;AACR;AACA,+CAA+C,SAAS;AACxD;AACA;;AAEA,0CAA0C,SAAS;AACnD;AACA;AACA;AACA;AACA;AACA;AACA,8CAA8C,YAAY;AAC1D;AACA;AACA,QAAQ;AACR;AACA,8CAA8C,mCAAmC;AACjF,QAAQ;AACR,8CAA8C,mCAAmC;AACjF;AACA;AACA;AACA;;AAEA,sCAAsC,SAAS;AAC/C;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,0CAA0C,iBAAiB;AAC3D,QAAQ;AACR;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,sBAAsB,mBAAmB;AACzC;AACA,sBAAsB,gBAAgB;AACtC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,0CAA0C,oCAAoC;AAC9E,QAAQ;AACR,0CAA0C,2BAA2B;AACrE;AACA;;AAEA;AACA,kCAAkC,oBAAoB;AACtD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,sCAAsC,+BAA+B,+BAA+B,MAAM;AAC1G;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,uBAAuB,kCAAkC,IAAI,kCAAkC;AAC/F,SAAS;AACT;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,4CAA4C,2BAA2B;AACvE;AACA;AACA;AACA;AACA;AACA,kDAAkD,mCAAmC;AACrF;AACA,0CAA0C,6BAA6B,+BAA+B,GAAG;AACzG;AACA;AACA;AACA;AACA;AACA;AACA,sCAAsC,+BAA+B,iCAAiC,MAAM;AAC5G,QAAQ;AACR;AACA,sCAAsC,sCAAsC;AAC5E;AACA;AACA;AACA;;AAEA;AACA,8BAA8B,oBAAoB;AAClD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,sCAAsC,+BAA+B,+BAA+B,MAAM;AAC1G;AACA;AACA;AACA;AACA,qEAAqE,uBAAuB;AAC5F;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,uBAAuB,8BAA8B,IAAI,8BAA8B;AACvF,SAAS;AACT;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,wCAAwC,uBAAuB;AAC/D;AACA;AACA;AACA;AACA;AACA,8CAA8C,2BAA2B;AACzE;AACA,0CAA0C,6BAA6B,iBAAiB,GAAG;AAC3F;AACA;AACA;AACA;AACA,sCAAsC,+BAA+B,iCAAiC,MAAM;AAC5G,QAAQ;AACR;AACA,sCAAsC,sCAAsC;AAC5E;AACA;AACA;AACA;;AAEA,6BAA6B,qBAAqB;AAClD;AACA;AACA;AACA,mBAAmB,YAAY;AAC/B;AACA;AACA,kBAAkB,eAAe,YAAY,mBAAmB;AAChE;AACA;AACA;AACA;AACA,SAAS;AACT,OAAO;AACP;;AAEA,iCAAiC,2BAA2B;AAC5D;AACA;AACA;AACA;AACA;AACA;AACA;AACA,8CAA8C,YAAY;AAC1D;AACA,sCAAsC,6BAA6B,0BAA0B,GAAG;AAChG;AACA;AACA;AACA;AACA,4CAA4C,6BAA6B;AACzE;AACA;AACA,oCAAoC;AACpC;AACA;;AAEA,6BAA6B,uBAAuB;AACpD;AACA;AACA;AACA;AACA;AACA;AACA;AACA,0CAA0C,QAAQ;AAClD;AACA,sCAAsC,6BAA6B,YAAY,GAAG;AAClF;AACA;AACA;AACA;AACA,wCAAwC,qBAAqB;AAC7D;AACA;AACA,gCAAgC;AAChC;AACA;;AAEA,qCAAqC,6BAA6B;AAClE;AACA;AACA,gEAAgE,uCAAuC;AACvG;AACA;AACA;AACA;AACA;AACA,wCAAwC,6CAA6C;AACrF;AACA,+CAA+C,wBAAwB;AACvE;;AAEA,iCAAiC,qBAAqB;AACtD;AACA;AACA,wDAAwD,2BAA2B;AACnF;AACA;AACA;AACA;AACA;AACA;AACA,wCAAwC,QAAQ;AAChD;AACA,2CAA2C,oBAAoB;AAC/D;;AAEA,qCAAqC,6BAA6B;AAClE;AACA;AACA,gEAAgE,uCAAuC;AACvG;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,kBAAkB,qCAAqC;AACvD,SAAS;AACT;AACA;AACA;AACA;AACA;;AAEA,6BAA6B,4CAA4C;AACzE;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,iCAAiC,yCAAyC;AAC1E;AACA,oCAAoC,4CAA4C;AAChF;;AAEA,iCAAiC,qBAAqB;AACtD;AACA;AACA,wDAAwD,2BAA2B;AACnF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAAS;AACT;AACA;AACA;AACA,2CAA2C,uCAAuC;AAClF;AACA;AACA;AACA;AACA;;AAEA,qCAAqC,YAAY;AACjD;AACA,2DAA2D,6CAA6C;AACxG;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAAO;AACP;AACA;AACA;AACA,gBAAgB,YAAY;AAC5B,OAAO;AACP;AACA;AACA;AACA;AACA;;AAEA;AACA,0BAA0B,uBAAuB;AACjD;AACA;AACA,8DAA8D,cAAc;AAC5E;AACA;AACA;AACA;AACA,+CAA+C,gCAAgC;AAC/E;AACA;;AAEA,6BAA6B,uBAAuB;AACpD;AACA;AACA,8DAA8D,cAAc;AAC5E;AACA;AACA;AACA;AACA,kDAAkD,gCAAgC;AAClF;AACA;;AAEA,iCAAiC,QAAQ;AACzC;AACA;AACA;AACA,6DAA6D,2CAA2C;AACxG;;AAEA;AACA;AACA,mCAAmC,qDAAqD;AACxF;AACA;;AAEA;AACA;AACA,2CAA2C,wBAAwB;AACnE;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,OAAO;AACP;AACA,+CAA+C,QAAQ;AACvD;;AAEA;AACA;AACA;;AAEA,sCAAsC,QAAQ;AAC9C;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,aAAa;AACb,WAAW;AACX;AACA;AACA;AACA,qBAAqB,iCAAiC;AACtD,SAAS;AACT,OAAO;AACP;;AAEA;AACA,iCAAiC,cAAc;AAC/C;AACA;AACA;AACA;AACA;AACA,+DAA+D,cAAc;AAC7E;AACA,4CAA4C,uBAAuB;AACnE;;AAEA;AACA;AACA;AACA;AACA,OAAO;AACP;AACA;AACA;AACA,OAAO;AACP;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA,OAAO;AACP;AACA;;AAEA;AACA;;;;;;;;ACjqBA;AACA;AACA,qBAAqB,KAAK;AAC1B;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,0BAA0B,KAAK;AAC/B;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;;;;;;;AC9BA;AACA;AACA;AACA,kBAAkB,SAAS;AAC3B;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,UAAU;AACV;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,gBAAgB,SAAS;AACzB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAAS;AACT,OAAO;AACP;;AAEA,qBAAqB,SAAS;AAC9B;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAAS;AACT,OAAO;AACP;AACA;AACA;AACA;;AAEA;AACA;;;;;;;;AC7DA,gBAAgB,mBAAO,CAAC,GAAsB;AAC9C,iBAAiB,mBAAO,CAAC,EAAuB;AAChD,cAAc,mBAAO,CAAC,GAAoB;AAC1C,iBAAiB,mBAAO,CAAC,GAAuB;;AAEhD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;ACbA;;;;;;;;ACAA;;;;;;UCAA;UACA;;UAEA;UACA;UACA;UACA;UACA;UACA;UACA;UACA;UACA;UACA;UACA;UACA;UACA;;UAEA;UACA;;UAEA;UACA;UACA;;;;UEtBA;UACA;UACA;UACA","sources":["webpack://egg-born-module-a-wxwork/./backend/src/bean/bean.wxwork.js","webpack://egg-born-module-a-wxwork/./backend/src/bean/event.accountMigration.js","webpack://egg-born-module-a-wxwork/./backend/src/bean/event.loginInfo.js","webpack://egg-born-module-a-wxwork/./backend/src/bean/io.channel.app.js","webpack://egg-born-module-a-wxwork/./backend/src/bean/middleware.inWxwork.js","webpack://egg-born-module-a-wxwork/./backend/src/bean/queue.contacts.js","webpack://egg-born-module-a-wxwork/./backend/src/bean/version.manager.js","webpack://egg-born-module-a-wxwork/./backend/src/beans.js","webpack://egg-born-module-a-wxwork/./backend/src/common/authProviderScenes.js","webpack://egg-born-module-a-wxwork/./backend/src/common/wechatUtils.js","webpack://egg-born-module-a-wxwork/./backend/src/common/wxworkHelper.js","webpack://egg-born-module-a-wxwork/./backend/src/config/config.js","webpack://egg-born-module-a-wxwork/./backend/src/config/config/jsApiList.js","webpack://egg-born-module-a-wxwork/./backend/src/config/config/jsApiListAgent.js","webpack://egg-born-module-a-wxwork/./backend/src/config/errors.js","webpack://egg-born-module-a-wxwork/./backend/src/config/locale/en-us.js","webpack://egg-born-module-a-wxwork/./backend/src/config/locale/zh-cn.js","webpack://egg-born-module-a-wxwork/./backend/src/config/locales.js","webpack://egg-born-module-a-wxwork/./backend/src/config/socketio/channelApp.js","webpack://egg-born-module-a-wxwork/./backend/src/config/socketio/messageProgress.js","webpack://egg-born-module-a-wxwork/./backend/src/config/validation/schemas.js","webpack://egg-born-module-a-wxwork/./backend/src/controller/authMini.js","webpack://egg-born-module-a-wxwork/./backend/src/controller/contacts.js","webpack://egg-born-module-a-wxwork/./backend/src/controller/jssdk.js","webpack://egg-born-module-a-wxwork/./backend/src/controller/message.js","webpack://egg-born-module-a-wxwork/./backend/src/controllers.js","webpack://egg-born-module-a-wxwork/./backend/src/main.js","webpack://egg-born-module-a-wxwork/./backend/src/meta.js","webpack://egg-born-module-a-wxwork/./backend/src/model/department.js","webpack://egg-born-module-a-wxwork/./backend/src/model/member.js","webpack://egg-born-module-a-wxwork/./backend/src/models.js","webpack://egg-born-module-a-wxwork/./backend/src/passport/auth.js","webpack://egg-born-module-a-wxwork/./backend/src/passport/oauth.js","webpack://egg-born-module-a-wxwork/./backend/src/passport/strategy-wxwork.js","webpack://egg-born-module-a-wxwork/./backend/src/routes.js","webpack://egg-born-module-a-wxwork/./backend/src/service/authMini.js","webpack://egg-born-module-a-wxwork/./backend/src/service/contacts.js","webpack://egg-born-module-a-wxwork/./backend/src/service/jssdk.js","webpack://egg-born-module-a-wxwork/./backend/src/service/message.js","webpack://egg-born-module-a-wxwork/./backend/src/services.js","webpack://egg-born-module-a-wxwork/external commonjs2 \"require3\"","webpack://egg-born-module-a-wxwork/external node-commonjs \"crypto\"","webpack://egg-born-module-a-wxwork/webpack/bootstrap","webpack://egg-born-module-a-wxwork/webpack/before-startup","webpack://egg-born-module-a-wxwork/webpack/startup","webpack://egg-born-module-a-wxwork/webpack/after-startup"],"sourcesContent":["const require3 = require('require3');\nconst WxworkAPI = require3('@zhennann/co-wxwork-api');\nconst WechatAPI = require3('@zhennann/co-wechat-api');\nmodule.exports = function (ctx) {\n  const moduleInfo = ctx.app.meta.mockUtil.parseInfoFromPackage(__dirname);\n\n  return function () {\n    return new Proxy(\n      {},\n      {\n        get(obj, prop) {\n          if (obj[prop]) return obj[prop];\n          if (prop === 'app') {\n            // app\n            obj[prop] = new Proxy(\n              {},\n              {\n                get(obj, prop) {\n                  if (!obj[prop]) {\n                    if (prop === 'mini') {\n                      // app.mini\n                      obj[prop] = new Proxy(\n                        {},\n                        {\n                          get(obj, prop) {\n                            if (!obj[prop]) {\n                              obj[prop] = _createWxworkApiApp({ appName: prop, mini: true });\n                            }\n                            return obj[prop];\n                          },\n                        }\n                      );\n                    } else {\n                      // others\n                      obj[prop] = _createWxworkApiApp({ appName: prop });\n                    }\n                  }\n                  return obj[prop];\n                },\n              }\n            );\n          } else if (prop === 'mini') {\n            // mini\n            obj[prop] = new Proxy(\n              {},\n              {\n                get(obj, prop) {\n                  if (!obj[prop]) {\n                    obj[prop] = _createWxworkApiMini({ sceneShort: prop });\n                  }\n                  return obj[prop];\n                },\n              }\n            );\n          } else if (prop === 'util') {\n            // util\n            obj[prop] = _createWxworkApiUtil();\n          }\n          return obj[prop];\n        },\n      }\n    );\n  };\n\n  function _createWxworkApiApp({ appName, mini }) {\n    // config\n    const config = ctx.config.module(moduleInfo.relativeName).account.wxwork;\n    const configApp = mini ? config.minis[appName] : config.apps[appName];\n    // api\n    const api = new WxworkAPI.CorpAPI(\n      config.corpid,\n      configApp.secret,\n      async function () {\n        const cacheKey = `wxwork-token:${appName || ''}`;\n        return await ctx.cache.db.module(moduleInfo.relativeName).get(cacheKey);\n      },\n      async function (token) {\n        const cacheKey = `wxwork-token:${appName || ''}`;\n        if (token) {\n          await ctx.cache.db.module(moduleInfo.relativeName).set(cacheKey, token, token.expireTime - Date.now());\n        } else {\n          await ctx.cache.db.module(moduleInfo.relativeName).remove(cacheKey);\n        }\n      }\n    );\n    // registerTicketHandle\n    api.registerTicketHandle(\n      async function (type) {\n        const cacheKey = `wxwork-jsticket:${appName}:${type}`;\n        return await ctx.cache.db.module(moduleInfo.relativeName).get(cacheKey);\n      },\n      async function (type, token) {\n        const cacheKey = `wxwork-jsticket:${appName}:${type}`;\n        if (token) {\n          await ctx.cache.db.module(moduleInfo.relativeName).set(cacheKey, token, token.expireTime - Date.now());\n        } else {\n          await ctx.cache.db.module(moduleInfo.relativeName).remove(cacheKey);\n        }\n      }\n    );\n    // ready\n    return api;\n  }\n\n  function _createWxworkApiMini({ sceneShort }) {\n    // config\n    const config = ctx.config.module(moduleInfo.relativeName).account.wxwork;\n    const configMini = config.minis[sceneShort];\n    // api\n    const api = new WechatAPI(\n      configMini.appID,\n      configMini.appSecret,\n      async function () {\n        const cacheKey = `wxworkmini-token:${sceneShort}`;\n        return await ctx.cache.db.module(moduleInfo.relativeName).get(cacheKey);\n      },\n      async function (token) {\n        const cacheKey = `wxworkmini-token:${sceneShort}`;\n        if (token) {\n          await ctx.cache.db.module(moduleInfo.relativeName).set(cacheKey, token, token.expireTime - Date.now());\n        } else {\n          await ctx.cache.db.module(moduleInfo.relativeName).remove(cacheKey);\n        }\n      }\n    );\n    // registerTicketHandle\n    api.registerTicketHandle(\n      async function (type) {\n        const cacheKey = `wxworkmini-jsticket:${sceneShort}:${type}`;\n        return await ctx.cache.db.module(moduleInfo.relativeName).get(cacheKey);\n      },\n      async function (type, token) {\n        const cacheKey = `wxworkmini-jsticket:${sceneShort}:${type}`;\n        if (token) {\n          await ctx.cache.db.module(moduleInfo.relativeName).set(cacheKey, token, token.expireTime - Date.now());\n        } else {\n          await ctx.cache.db.module(moduleInfo.relativeName).remove(cacheKey);\n        }\n      }\n    );\n    // registerSessionKeyHandle\n    api.registerSessionKeyHandle(\n      async function () {\n        const cacheKey = `wxworkmini-sessionKey:${sceneShort}:${ctx.state.user.agent.id}`;\n        return await ctx.cache.db.module(moduleInfo.relativeName).get(cacheKey);\n      },\n      async function (sessionKey) {\n        const cacheKey = `wxworkmini-sessionKey:${sceneShort}:${ctx.state.user.agent.id}`;\n        await ctx.cache.db.module(moduleInfo.relativeName).set(cacheKey, sessionKey);\n      }\n    );\n    // ready\n    return api;\n  }\n\n  function _createWxworkApiUtil() {\n    return {\n      // scene: empty/wxwork/wxworkweb/wxworkmini/wxworkminidefault/xxx,xxx,xxx\n      in(scene) {\n        // scene\n        if (!scene) scene = 'wxwork';\n        if (typeof scene === 'string') scene = scene.split(',');\n        // provider\n        const provider = ctx.state.user && ctx.state.user.provider;\n        if (!provider || provider.module !== moduleInfo.relativeName) return false;\n        // find any match\n        for (const item of scene) {\n          const ok =\n            provider.providerName === item || (item === 'wxworkmini' && provider.providerName.indexOf(item) > -1);\n          if (ok) return true;\n        }\n        // not found\n        return false;\n      },\n    };\n  }\n};\n","module.exports = ctx => {\n  // const moduleInfo = ctx.app.meta.mockUtil.parseInfoFromPackage(__dirname);\n  class eventBean {\n    async execute(context, next) {\n      const data = context.data;\n      // aWxworkMember\n      await ctx.model.query('update aWxworkMember a set a.userId=? where a.iid=? and a.userId=?', [\n        data.userIdTo,\n        ctx.instance.id,\n        data.userIdFrom,\n      ]);\n      // next\n      await next();\n    }\n  }\n\n  return eventBean;\n};\n","const require3 = require('require3');\nconst extend = require3('extend2');\n\nmodule.exports = ctx => {\n  class eventBean {\n    async execute(context, next) {\n      const info = context.data.info;\n      const provider = info.user && info.user.provider;\n      if (provider && provider.module === 'a-wxwork') {\n        info.config = extend(true, info.config, {\n          modules: {},\n        });\n      }\n      // next\n      await next();\n    }\n  }\n\n  return eventBean;\n};\n","module.exports = ctx => {\n  const moduleInfo = ctx.app.meta.mockUtil.parseInfoFromPackage(__dirname);\n  class IOChannel extends ctx.app.meta.IOChannelBase(ctx) {\n    async onPush({ content /* options, message, messageSync, messageClass*/ }) {\n      // userIds / roleIds\n      const userIds = content.userIds;\n      const roleIds = content.roleIds;\n      // message\n      const message = {\n        ...content.data,\n      };\n      // agentid\n      const config = ctx.config.module(moduleInfo.relativeName).account.wxwork;\n      message.agentid = config.apps.selfBuilt.agentid;\n      // userIds\n      if (userIds && userIds.length > 0) {\n        const modelMember = ctx.model.module(moduleInfo.relativeName).member;\n        const list = await modelMember.select({\n          where: { userId: userIds },\n          columns: ['memberId'],\n        });\n        message.touser = list.map(item => item.memberId).join('|');\n      }\n      // roleIds\n      if (roleIds && roleIds.length > 0) {\n        const modelDepartment = ctx.model.module(moduleInfo.relativeName).department;\n        const list = await modelDepartment.select({\n          where: { roleId: roleIds },\n          columns: ['departmentId'],\n        });\n        message.toparty = list.map(item => item.departmentId).join('|');\n      }\n      // send\n      await ctx.bean.wxwork.app.selfBuilt.sendMessage(message);\n      // done\n      return true;\n    }\n  }\n  return IOChannel;\n};\n","module.exports = ctx => {\n  const moduleInfo = ctx.app.meta.mockUtil.parseInfoFromPackage(__dirname);\n  class Middleware {\n    async execute(options, next) {\n      if (!ctx.bean.wxwork.util.in(options.scene)) return ctx.throw.module(moduleInfo.relativeName, 1001);\n      // next\n      await next();\n    }\n  }\n  return Middleware;\n};\n","module.exports = app => {\n  class Queue extends app.meta.BeanBase {\n    async execute(context) {\n      const data = context.data;\n      const queueAction = data.queueAction;\n      if (queueAction === 'sync') {\n        await this.ctx.service.contacts.queueSync(data);\n      } else if (queueAction === 'changeContact') {\n        await this.ctx.service.contacts.queueChangeContact(data);\n      }\n    }\n  }\n\n  return Queue;\n};\n","module.exports = app => {\n  class Version extends app.meta.BeanBase {\n    async update(options) {\n      if (options.version === 1) {\n        let sql;\n\n        // create table: aWxworkDepartment\n        sql = `\n          CREATE TABLE aWxworkDepartment (\n            id int(11) NOT NULL AUTO_INCREMENT,\n            createdAt timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,\n            updatedAt timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n            deleted int(11) DEFAULT '0',\n            iid int(11) DEFAULT '0',\n            roleId int(11) DEFAULT '0',\n            departmentId int(11) DEFAULT '0',\n            departmentParentId int(11) DEFAULT '0',\n            departmentName varchar(255) DEFAULT NULL,\n            departmentNameEn varchar(255) DEFAULT NULL,\n            departmentOrder int(11) DEFAULT '0',\n            PRIMARY KEY (id)\n          )\n        `;\n        await this.ctx.model.query(sql);\n\n        // create table: aWxworkMember\n        sql = `\n          CREATE TABLE aWxworkMember (\n            id int(11) NOT NULL AUTO_INCREMENT,\n            createdAt timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,\n            updatedAt timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n            deleted int(11) DEFAULT '0',\n            iid int(11) DEFAULT '0',\n            userId int(11) DEFAULT '0',\n            memberId varchar(255) DEFAULT NULL,\n            name varchar(255) DEFAULT NULL,\n            alias varchar(255) DEFAULT NULL,\n            mobile varchar(255) DEFAULT NULL,\n            department varchar(255) DEFAULT NULL,\n            sorting varchar(255) DEFAULT NULL,\n            position varchar(255) DEFAULT NULL,\n            gender int(11) DEFAULT '0',\n            email varchar(255) DEFAULT NULL,\n            telephone varchar(255) DEFAULT NULL,\n            is_leader_in_dept varchar(255) DEFAULT NULL,\n            avatar varchar(255) DEFAULT NULL,\n            thumb_avatar varchar(255) DEFAULT NULL,\n            qr_code varchar(255) DEFAULT NULL,\n            status int(11) DEFAULT '0',\n            extattr JSON DEFAULT NULL,\n            external_profile JSON DEFAULT NULL,\n            external_position varchar(255) DEFAULT NULL,\n            address varchar(255) DEFAULT NULL,\n            hide_mobile int(11) DEFAULT '0',\n            english_name varchar(255) DEFAULT NULL,\n            open_userid varchar(255) DEFAULT NULL,\n            main_department int(11) DEFAULT '0',\n            PRIMARY KEY (id)\n          )\n        `;\n        await this.ctx.model.query(sql);\n      }\n    }\n\n    async init(options) {}\n\n    async test() {}\n  }\n\n  return Version;\n};\n","const versionManager = require('./bean/version.manager.js');\nconst eventLoginInfo = require('./bean/event.loginInfo.js');\nconst eventAccountMigration = require('./bean/event.accountMigration.js');\nconst queueContacts = require('./bean/queue.contacts.js');\nconst middlewareInWxwork = require('./bean/middleware.inWxwork.js');\nconst ioChannelApp = require('./bean/io.channel.app.js');\nconst beanWxwork = require('./bean/bean.wxwork.js');\n\nmodule.exports = app => {\n  const beans = {\n    // version\n    'version.manager': {\n      mode: 'app',\n      bean: versionManager,\n    },\n    // event\n    'event.loginInfo': {\n      mode: 'ctx',\n      bean: eventLoginInfo,\n    },\n    'event.accountMigration': {\n      mode: 'ctx',\n      bean: eventAccountMigration,\n    },\n    // queue\n    'queue.contacts': {\n      mode: 'app',\n      bean: queueContacts,\n    },\n    // middleware\n    'middleware.inWxwork': {\n      mode: 'ctx',\n      bean: middlewareInWxwork,\n    },\n    // io\n    'io.channel.app': {\n      mode: 'ctx',\n      bean: ioChannelApp,\n    },\n    // global\n    wxwork: {\n      mode: 'ctx',\n      bean: beanWxwork,\n      global: true,\n    },\n  };\n  return beans;\n};\n","const _scenes = {\n  wxwork: {\n    scene: 'wxwork',\n    authProvider: 'wxwork',\n    title: 'Wechat Work',\n    client: 'wxwork',\n    disableAssociate: false,\n  },\n  wxworkweb: {\n    scene: 'wxworkweb',\n    authProvider: 'wxworkweb',\n    title: 'Wechat Work Web',\n    client: 'wxworkweb',\n    disableAssociate: false,\n  },\n  wxworkmini: {\n    scene: 'wxworkmini',\n    authProvider: 'wxworkmini',\n    title: 'Wechat Work Miniprogram',\n    disableAssociate: true,\n  },\n};\n\nfunction _upperCaseFirstChar(str) {\n  if (!str) return '';\n  return str.substring(0, 1).toUpperCase() + str.substring(1);\n}\n\nmodule.exports = {\n  scenes: _scenes,\n  getScene(scene) {\n    if (scene.indexOf('wxworkmini') > -1) {\n      const sceneShort = scene.substr('wxworkmini'.length);\n      // wxworkmini\n      const base = _scenes.wxworkmini;\n      return {\n        scene,\n        authProvider: scene,\n        title: `${base.title} - ${_upperCaseFirstChar(sceneShort)}`,\n      };\n    }\n    // else\n    return _scenes[scene];\n  },\n};\n","const crypto = require('crypto');\nconst require3 = require('require3');\nconst bb = require3('bluebird');\nconst xml2js = require3('xml2js');\n\nmodule.exports = {\n  createNonceStr() {\n    return Math.random().toString(36).substr(2, 15);\n  },\n  createTimestamp() {\n    return '' + Math.floor(Date.now() / 1000);\n  },\n  calcSignature({ options, join = '', hash = 'sha1' }) {\n    const hashsum = crypto.createHash(hash);\n    hashsum.update(options.join(join));\n    return hashsum.digest('hex');\n  },\n  async parseXML({ xml, trim = true, explicitArray = false, explicitRoot = false }) {\n    const parser = new xml2js.Parser({ trim, explicitArray, explicitRoot });\n    return await bb.fromCallback(cb => {\n      parser.parseString(xml, cb);\n    });\n  },\n  buildXML({ xml, cdata = true, headless = true, rootName = 'xml' }) {\n    return new xml2js.Builder({ cdata, headless, rootName }).buildObject(xml);\n  },\n};\n","const require3 = require('require3');\nconst bb = require3('bluebird');\nconst extend = require3('extend2');\nconst authProviderScenes = require('./authProviderScenes.js');\n\nmodule.exports = function (ctx) {\n  const moduleInfo = ctx.app.meta.mockUtil.parseInfoFromPackage(__dirname);\n  class WxworkHelper {\n    getSceneInfo(scene) {\n      return authProviderScenes.getScene(scene);\n    }\n\n    // scene: wxwork/wxworkweb/wxworkmini\n    async verifyAuthUser({ scene, memberId, member, cbVerify, state, needLogin = true }) {\n      // userInfo(member)\n      if (!member) {\n        member = await this._getMemberByMemberId({ memberId });\n        if (!member) return ctx.throw.module(moduleInfo.relativeName, 1008);\n      }\n      // ensure auth user\n      const profileUser = await this._ensureAuthUser({ scene, memberId: member.memberId, member });\n      // verify\n      let verifyUser;\n      if (!cbVerify) {\n        verifyUser = await ctx.bean.user.verify({ state, profileUser });\n        if (needLogin) {\n          await ctx.login(verifyUser);\n        }\n      } else {\n        verifyUser = await bb.fromCallback(cb => {\n          cbVerify(profileUser, cb);\n        });\n      }\n      // ok\n      return verifyUser;\n    }\n\n    async _getMemberByMemberId({ memberId }) {\n      // model member\n      const modelMember = ctx.model.module(moduleInfo.relativeName).member;\n      return await modelMember.get({ memberId });\n    }\n\n    // profileId: wxwork:memberId\n    async _ensureAuthUser({ scene, memberId, member }) {\n      // config\n      const config = ctx.config.module(moduleInfo.relativeName);\n      // model auth\n      const modelAuth = ctx.model.module('a-base').auth;\n      //\n      const sceneInfo = this.getSceneInfo(scene);\n      const profileId = `wxwork:${memberId}`;\n      const profileUser = {\n        module: moduleInfo.relativeName,\n        provider: sceneInfo.authProvider,\n        profileId,\n        profile: {\n          userName: member.alias || member.name,\n          realName: member.name,\n          avatar: member.avatar,\n          email: member.email,\n          mobile: member.mobile,\n          emailConfirmed: true,\n          mobileVerified: true,\n          profile: member,\n        },\n        autoActivate: config.auth.autoActivate,\n      };\n      // provider\n      const providerItem = await ctx.bean.user.getAuthProvider({\n        module: moduleInfo.relativeName,\n        providerName: sceneInfo.authProvider,\n      });\n      // check auth\n      let authId;\n      let authUserId;\n      const authItems = await ctx.model.query(\n        'select * from aAuth a where a.deleted=0 and a.iid=? and a.providerId=? and a.profileId=?',\n        [ctx.instance.id, providerItem.id, profileId]\n      );\n      const authItem = authItems[0];\n      if (!authItem) {\n        // always set avatar empty\n        const _profile = extend(true, {}, profileUser.profile);\n        delete _profile.avatar;\n        // insert auth\n        const res = await modelAuth.insert({\n          providerId: providerItem.id,\n          profileId,\n          profile: JSON.stringify(_profile),\n        });\n        authId = res.insertId;\n      } else {\n        // hold old avatar empty\n        const _profile = extend(true, {}, profileUser.profile);\n        const _profileOld = JSON.parse(authItem.profile);\n        _profile.avatar = _profileOld.avatar;\n        // always update\n        await modelAuth.update({\n          id: authItem.id,\n          profile: JSON.stringify(_profile),\n        });\n        authId = authItem.id;\n        authUserId = authItem.userId;\n      }\n      // check if has userId for memberId\n      const _authOthers = await ctx.model.query(\n        'select * from aAuth a where a.deleted=0 and a.iid=? and a.profileId=? and a.id<>?',\n        [ctx.instance.id, profileId, authId]\n      );\n      const _authOther = _authOthers[0];\n      if (_authOther && _authOther.userId !== authUserId) {\n        // update userId for this auth\n        await modelAuth.update({ id: authId, userId: _authOther.userId });\n      }\n      // ready\n      return profileUser;\n    }\n  }\n\n  return WxworkHelper;\n};\n","const jsApiList = require('./config/jsApiList.js');\nconst jsApiListAgent = require('./config/jsApiListAgent.js');\n\nmodule.exports = appInfo => {\n  const config = {};\n\n  // queues\n  config.queues = {\n    contacts: {\n      bean: 'contacts',\n      transaction: true,\n    },\n  };\n\n  // middlewares\n  config.middlewares = {\n    inWxwork: {\n      bean: 'inWxwork',\n      global: false,\n      dependencies: 'instance',\n    },\n  };\n\n  // sync\n  config.sync = {\n    department: {\n      roleContainer: 'internal',\n      roleTop: 'wxwork',\n    },\n  };\n\n  // auth\n  config.auth = {\n    autoActivate: true,\n  };\n\n  // account\n  config.account = {};\n\n  // account.wxwork\n  config.account.wxwork = {\n    corpid: '',\n    // apps\n    apps: {\n      selfBuilt: {\n        agentid: '',\n        secret: '',\n        token: appInfo.name,\n        encodingAESKey: '',\n        message: {\n          reply: {\n            default: 'You are welcome!',\n          },\n        },\n        jssdk: {\n          debug: false,\n          jsApiList,\n        },\n        jssdkAgent: {\n          jsApiList: jsApiListAgent,\n        },\n      },\n      contacts: {\n        secret: '',\n        token: appInfo.name,\n        encodingAESKey: '',\n      },\n    },\n    // minis\n    minis: {\n      default: {\n        secret: '',\n        appID: '',\n        appSecret: '',\n      },\n    },\n  };\n\n  // settings\n  config.settings = {\n    instance: {\n      groupInfo: {\n        sendLinkAccountMigration: false,\n      },\n      groupFunction: {},\n    },\n  };\n\n  return config;\n};\n","module.exports = [\n  'checkJsApi',\n  'agentConfig',\n  'onMenuShareWechat',\n  // 'onMenuShareTimeline',\n  // 'onMenuShareAppMessage',\n  'startRecord',\n  'stopRecord',\n  'onVoiceRecordEnd',\n  'playVoice',\n  'pauseVoice',\n  'stopVoice',\n  'onVoicePlayEnd',\n  'uploadVoice',\n  'downloadVoice',\n  'chooseImage',\n  'previewImage',\n  'uploadImage',\n  'downloadImage',\n  'getLocalImgData',\n  'getNetworkType',\n  'onNetworkStatusChange',\n  'openLocation',\n  'getLocation',\n  'startAutoLBS',\n  'stopAutoLBS',\n  'onLocationChange',\n  'onHistoryBack',\n  'hideOptionMenu',\n  'showOptionMenu',\n  'hideMenuItems',\n  'showMenuItems',\n  'hideAllNonBaseMenuItem',\n  'showAllNonBaseMenuItem',\n  'closeWindow',\n  'openDefaultBrowser',\n  'scanQRCode',\n  'selectEnterpriseContact',\n  'openEnterpriseChat',\n  'chooseInvoice',\n  'selectExternalContact',\n  'getCurExternalContact',\n  'openUserProfile',\n  'shareAppMessage',\n  'shareWechatMessage',\n  'startWifi',\n  'stopWifi',\n  'connectWifi',\n  'getWifiList',\n  'onGetWifiList',\n  'onWifiConnected',\n  'getConnectedWifi',\n  'setClipboardData',\n];\n","module.exports = [\n  'onMenuShareWechat',\n  // 'onMenuShareTimeline',\n  // 'onMenuShareAppMessage',\n  'startRecord',\n  'stopRecord',\n  'onVoiceRecordEnd',\n  'playVoice',\n  'pauseVoice',\n  'stopVoice',\n  'onVoicePlayEnd',\n  'uploadVoice',\n  'downloadVoice',\n  'chooseImage',\n  'previewImage',\n  'uploadImage',\n  'downloadImage',\n  'getLocalImgData',\n  'getNetworkType',\n  'onNetworkStatusChange',\n  'openLocation',\n  'getLocation',\n  'startAutoLBS',\n  'stopAutoLBS',\n  'onLocationChange',\n  'onHistoryBack',\n  'hideOptionMenu',\n  'showOptionMenu',\n  'hideMenuItems',\n  'showMenuItems',\n  'hideAllNonBaseMenuItem',\n  'showAllNonBaseMenuItem',\n  'closeWindow',\n  'openDefaultBrowser',\n  'scanQRCode',\n  'selectEnterpriseContact',\n  'openEnterpriseChat',\n  'chooseInvoice',\n  'selectExternalContact',\n  'getCurExternalContact',\n  'openUserProfile',\n  'shareAppMessage',\n  'shareWechatMessage',\n  'startWifi',\n  'stopWifi',\n  'connectWifi',\n  'getWifiList',\n  'onGetWifiList',\n  'onWifiConnected',\n  'getConnectedWifi',\n  'setClipboardData',\n];\n","// error code should start from 1001\nmodule.exports = {\n  1001: 'Not In Wechat Work',\n  1002: 'Not In Wechat Work Miniprogram',\n  1003: 'Role not Found for department: %d',\n  1004: 'Department not Found: %d',\n  1005: 'Member not Found: %d',\n  1006: 'Sync Departments First',\n  1007: 'Sync Members First',\n  1008: 'Sync Contacts First',\n};\n","module.exports = {\n  AccountMigration: 'Account Migration',\n  AccountMigrationDesp: 'Click this link to migrate to the existed account',\n};\n","module.exports = {\n  AccountMigration: '账户迁移',\n  AccountMigrationDesp: '点击此链接迁移至现有账户',\n  'Wechat Work': '企业微信',\n  'Wechat Work Miniprogram': '企业微信小程序',\n  'Wechat Work Miniprogram - Default': '企业微信小程序 - 默认',\n  'Wechat Work Web': '企业微信Web',\n  'Wechat Public': '微信公众号',\n  'Wechat Miniprogram': '微信小程序',\n  'Not In Wechat Work': '不在企业微信内部',\n  'Not In Wechat Work Miniprogram': '不在企业微信小程序内部',\n  'Contacts Management': '通讯录管理',\n  'Sync Started': '同步已启动',\n  'Sync Completed': '同步已完成',\n  'Department Count': '部门数量',\n  'Member Count': '成员数量',\n  'Sync Departments First': '请先同步部门',\n  'Sync Members First': '请先同步成员',\n  'Sync Contacts First': '请先同步通讯录',\n};\n","module.exports = {\n  'en-us': require('./locale/en-us.js'),\n  'zh-cn': require('./locale/zh-cn.js'),\n};\n","module.exports = app => {\n  const ChannelApp = {\n    info: {\n      bean: 'app',\n      title: 'App Message',\n    },\n  };\n  return ChannelApp;\n};\n","module.exports = app => {\n  const progress = {\n    info: {\n      title: 'Progress',\n      persistence: true,\n    },\n  };\n  return progress;\n};\n","module.exports = app => {\n  const schemas = {};\n\n  // settings instance\n  schemas.settingsInstance = {\n    type: 'object',\n    properties: {\n      groupInfo: {\n        type: 'object',\n        ebType: 'group',\n        ebTitle: 'Info Group',\n        properties: {\n          sendLinkAccountMigration: {\n            type: 'boolean',\n            ebType: 'toggle',\n            ebTitle: 'SendLinkAccountMigration',\n          },\n        },\n      },\n      groupFunction: {\n        type: 'object',\n        ebType: 'group',\n        ebTitle: 'Function Group',\n        properties: {\n          linkContacts: {\n            ebType: 'link',\n            ebTitle: 'Contacts Management',\n            ebParams: {\n              href: 'contacts/management',\n              target: '_self',\n            },\n          },\n        },\n      },\n    },\n  };\n\n  return schemas;\n};\n","module.exports = app => {\n  class AuthMiniController extends app.Controller {\n    async login() {\n      const res = await this.service.authMini.login({\n        scene: this.ctx.request.body.scene,\n        code: this.ctx.request.body.code,\n      });\n      this.ctx.success(res);\n    }\n  }\n  return AuthMiniController;\n};\n","const require3 = require('require3');\nconst uuid = require3('uuid');\n\nmodule.exports = app => {\n  const moduleInfo = app.meta.mockUtil.parseInfoFromPackage(__dirname);\n  class ContactsController extends app.Controller {\n    async sync() {\n      // progress\n      const progressId = uuid.v4().replace(/-/g, '');\n      // queue\n      this.ctx.app.meta.queue.push({\n        locale: this.ctx.locale,\n        subdomain: this.ctx.subdomain,\n        module: moduleInfo.relativeName,\n        queueName: 'contacts',\n        data: {\n          queueAction: 'sync',\n          type: this.ctx.request.body.type,\n          progressId,\n          userOp: this.ctx.state.user.op,\n        },\n      });\n      this.ctx.success({ progressId });\n    }\n\n    async syncStatus() {\n      const res = await this.service.contacts.syncStatus();\n      this.ctx.success(res);\n    }\n  }\n  return ContactsController;\n};\n","module.exports = app => {\n  class JSSDKController extends app.Controller {\n    async jsconfig() {\n      const res = await this.service.jssdk.jsconfig({\n        url: this.ctx.request.body.url,\n      });\n      this.ctx.success(res);\n    }\n\n    async jsconfigAgent() {\n      const res = await this.service.jssdk.jsconfigAgent({\n        url: this.ctx.request.body.url,\n      });\n      this.ctx.success(res);\n    }\n  }\n  return JSSDKController;\n};\n","const require3 = require('require3');\nconst WechatCrypto = require3('wechat-crypto');\nconst wechatUtils = require('../common/wechatUtils.js');\n\nmodule.exports = app => {\n  class MessageController extends app.Controller {\n    async index() {\n      await this._handleMessage('selfBuilt', async ({ message }) => {\n        return await this.ctx.service.message.index({ message });\n      });\n    }\n\n    async contacts() {\n      await this._handleMessage('contacts', async ({ message }) => {\n        return await this.ctx.service.message.contacts({ message });\n      });\n    }\n\n    async _handleMessage(appName, handler) {\n      // query\n      const query = this.ctx.query;\n      // config\n      const config = this.ctx.config.account.wxwork;\n      const configApp = config.apps[appName];\n      // encrypted: always true\n      const encrypted = true; // query.encrypt_type === 'aes';\n      // wechat crypto\n      const wechatCrypto = encrypted\n        ? new WechatCrypto(configApp.token, configApp.encodingAESKey, config.corpid)\n        : null;\n      // parse\n      let messageIn;\n      if (this.ctx.method === 'GET') {\n        messageIn = await this._parseMessageGet({ query, configApp, encrypted, wechatCrypto });\n        // ok\n        this.ctx.status = 200;\n        this.ctx.type = 'text/plain';\n        this.ctx.body = messageIn.echostr;\n      } else {\n        messageIn = await this._parseMessagePost({ query, configApp, encrypted, wechatCrypto });\n        // handle\n        let resXML;\n        const messageOut = await handler({ message: messageIn });\n        if (!messageOut) {\n          resXML = '';\n        } else {\n          resXML = wechatUtils.buildXML({ xml: messageOut });\n          if (encrypted) {\n            const wrap = {};\n            wrap.Encrypt = wechatCrypto.encrypt(resXML);\n            wrap.TimeStamp = wechatUtils.createTimestamp();\n            wrap.Nonce = wechatUtils.createNonceStr();\n            wrap.MsgSignature = wechatCrypto.getSignature(wrap.TimeStamp, wrap.Nonce, wrap.Encrypt);\n            resXML = wechatUtils.buildXML({ xml: wrap });\n          }\n        }\n        // ok\n        this.ctx.status = 200;\n        this.ctx.type = 'text/xml';\n        this.ctx.body = resXML;\n      }\n    }\n\n    async _parseMessageGet({ query, configApp, encrypted, wechatCrypto }) {\n      // check if valid\n      let valid = false;\n      if (encrypted) {\n        valid = query.msg_signature === wechatCrypto.getSignature(query.timestamp, query.nonce, query.echostr);\n      } else {\n        valid =\n          query.signature ===\n          wechatUtils.calcSignature({ options: [configApp.token, query.timestamp, query.nonce].sort() });\n      }\n      if (!valid) this.ctx.throw(401);\n      // decrypt\n      if (encrypted) {\n        const res = wechatCrypto.decrypt(query.echostr);\n        return { echostr: res.message };\n      }\n      return { echostr: query.echostr };\n    }\n\n    async _parseMessagePost({ query, configApp, encrypted, wechatCrypto }) {\n      // xml raw\n      let xmlRaw;\n      if (typeof this.ctx.request.body === 'string') {\n        xmlRaw = this.ctx.request.body;\n      } else {\n        const payload = await this.ctx.getPayload();\n        xmlRaw = payload.toString();\n      }\n      // parse xml\n      let xml = await wechatUtils.parseXML({ xml: xmlRaw });\n      // check if valid\n      let valid = false;\n      if (encrypted) {\n        valid = query.msg_signature === wechatCrypto.getSignature(query.timestamp, query.nonce, xml.Encrypt);\n      } else {\n        valid =\n          query.signature ===\n          wechatUtils.calcSignature({ options: [configApp.token, query.timestamp, query.nonce].sort() });\n      }\n      if (!valid) this.ctx.throw(401);\n      // decrypt\n      if (encrypted) {\n        const res = wechatCrypto.decrypt(xml.Encrypt);\n        xml = await wechatUtils.parseXML({ xml: res.message });\n      }\n      return xml;\n    }\n  }\n  return MessageController;\n};\n","const message = require('./controller/message.js');\nconst contacts = require('./controller/contacts.js');\n\nconst jssdk = require('./controller/jssdk.js');\nconst authMini = require('./controller/authMini.js');\n\nmodule.exports = app => {\n  const controllers = {\n    message,\n    contacts,\n    jssdk,\n    authMini,\n  };\n  return controllers;\n};\n","const config = require('./config/config.js');\nconst locales = require('./config/locales.js');\nconst errors = require('./config/errors.js');\n\nmodule.exports = app => {\n  // beans\n  const beans = require('./beans.js')(app);\n  // routes\n  const routes = require('./routes.js')(app);\n  // controllers\n  const controllers = require('./controllers.js')(app);\n  // services\n  const services = require('./services.js')(app);\n  // models\n  const models = require('./models.js')(app);\n  // meta\n  const meta = require('./meta.js')(app);\n\n  return {\n    beans,\n    routes,\n    controllers,\n    services,\n    models,\n    config,\n    locales,\n    errors,\n    meta,\n  };\n};\n","const authFn = require('./passport/auth.js');\n\nmodule.exports = app => {\n  const schemas = require('./config/validation/schemas.js')(app);\n  // socketio\n  const socketioMessageProgress = require('./config/socketio/messageProgress.js')(app);\n  const socketioChannelApp = require('./config/socketio/channelApp.js')(app);\n  const meta = {\n    base: {\n      atoms: {},\n    },\n    validation: {\n      validators: {\n        settingsInstance: {\n          schemas: 'settingsInstance',\n        },\n      },\n      keywords: {},\n      schemas: {\n        settingsInstance: schemas.settingsInstance,\n      },\n    },\n    settings: {\n      instance: {\n        validator: 'settingsInstance',\n      },\n    },\n    event: {\n      declarations: {\n        wxworkMessage: 'Wechat Work Message',\n      },\n      implementations: {\n        'a-base:loginInfo': 'loginInfo',\n        'a-base:accountMigration': 'accountMigration',\n      },\n    },\n    socketio: {\n      messages: {\n        progress: socketioMessageProgress,\n      },\n      channels: {\n        app: socketioChannelApp,\n      },\n    },\n    auth: authFn,\n  };\n  return meta;\n};\n","module.exports = app => {\n  class Department extends app.meta.Model {\n    constructor(ctx) {\n      super(ctx, { table: 'aWxworkDepartment', options: { disableDeleted: true } });\n    }\n  }\n  return Department;\n};\n","module.exports = app => {\n  class Member extends app.meta.Model {\n    constructor(ctx) {\n      super(ctx, { table: 'aWxworkMember', options: { disableDeleted: false } });\n    }\n  }\n  return Member;\n};\n","const department = require('./model/department.js');\nconst member = require('./model/member.js');\n\nmodule.exports = app => {\n  const models = {\n    department,\n    member,\n  };\n  return models;\n};\n","const strategy = require('./strategy-wxwork.js');\nconst WxworkHelperFn = require('../common/wxworkHelper.js');\nconst authProviderScenes = require('../common/authProviderScenes.js');\n\nmodule.exports = ctx => {\n  const moduleInfo = ctx.app.meta.mockUtil.parseInfoFromPackage(__dirname);\n\n  function _createProvider(sceneInfo) {\n    const config = ctx.config.module(moduleInfo.relativeName).account.wxwork;\n    if (!config.corpid || !config.apps.selfBuilt.agentid) return null;\n    return {\n      meta: {\n        title: sceneInfo.title,\n        mode: 'redirect',\n        disableAssociate: sceneInfo.disableAssociate,\n        component: `button${sceneInfo.authProvider}`,\n      },\n      config: {\n        client: sceneInfo.client,\n        scope: 'snsapi_base',\n      },\n      configFunctions: {\n        getConfig(ctx) {\n          const config = ctx.config.module(moduleInfo.relativeName).account.wxwork;\n          return { corpid: config.corpid, agentid: config.apps.selfBuilt.agentid };\n        },\n      },\n      handler: app => {\n        return {\n          strategy,\n          callback: (req, code, done) => {\n            // ctx/state\n            const ctx = req.ctx;\n            const state = ctx.request.query.state || 'login';\n            // code/memberId\n            const wxworkHelper = new (WxworkHelperFn(ctx))();\n            ctx.bean.wxwork.app.selfBuilt\n              .getUserIdByCode(code)\n              .then(res => {\n                if (res.errcode) throw new Error(res.errmsg);\n                const memberId = res.UserId;\n                wxworkHelper\n                  .verifyAuthUser({\n                    scene: sceneInfo.scene,\n                    memberId,\n                    state,\n                    cbVerify: (profileUser, cb) => {\n                      app.passport.doVerify(req, profileUser, cb);\n                    },\n                  })\n                  .then(verifyUser => {\n                    done(null, verifyUser);\n                  })\n                  .catch(done);\n              })\n              .catch(done);\n          },\n        };\n      },\n    };\n  }\n\n  function _createProviderMini(sceneInfo, sceneShort) {\n    const config = ctx.config.module(moduleInfo.relativeName).account.wxwork.minis[sceneShort];\n    if (!config.appID || !config.appSecret) return null;\n    return {\n      meta: {\n        title: sceneInfo.title,\n        mode: 'direct',\n        disableAssociate: true,\n      },\n      config: {},\n      handler: null,\n    };\n  }\n\n  const metaAuth = {\n    providers: {},\n  };\n\n  // wxwork/wxworkweb\n  for (const scene of ['wxwork', 'wxworkweb']) {\n    const sceneInfo = authProviderScenes.getScene(scene);\n    metaAuth.providers[sceneInfo.authProvider] = _createProvider(sceneInfo);\n  }\n\n  // minis\n  const minis = ctx.config.module(moduleInfo.relativeName).account.wxwork.minis;\n  for (const sceneShort in minis) {\n    const scene = `wxworkmini${sceneShort}`;\n    const sceneInfo = authProviderScenes.getScene(scene);\n    metaAuth.providers[sceneInfo.authProvider] = _createProviderMini(sceneInfo, sceneShort);\n  }\n\n  // ok\n  return metaAuth;\n};\n","const require3 = require('require3');\nconst querystring = require3('querystring');\n\nconst OAuth = function (appid, agentid) {\n  this.appid = appid;\n  this.agentid = agentid;\n};\n\nOAuth.prototype.getAuthorizeURL = function (redirect, state, scope) {\n  const url = 'https://open.weixin.qq.com/connect/oauth2/authorize';\n  const info = {\n    appid: this.appid,\n    redirect_uri: redirect,\n    response_type: 'code',\n    scope: scope || 'snsapi_base',\n    state: state || '',\n  };\n\n  return url + '?' + querystring.stringify(info) + '#wechat_redirect';\n};\n\nOAuth.prototype.getAuthorizeURLForWebsite = function (redirect, state) {\n  const url = 'https://open.work.weixin.qq.com/wwopen/sso/qrConnect';\n  const info = {\n    appid: this.appid,\n    agentid: this.agentid,\n    redirect_uri: redirect,\n    state: state || '',\n  };\n\n  return url + '?' + querystring.stringify(info);\n};\n\nmodule.exports = OAuth;\n","const require3 = require('require3');\nconst util = require3('util');\nconst passport = require3('passport-strategy');\nconst OAuth = require('./oauth.js');\n\nfunction WxworkStrategy(options, verify) {\n  options = options || {};\n\n  if (!verify) {\n    throw new TypeError('WxworkStrategy required a verify callback');\n  }\n\n  if (typeof verify !== 'function') {\n    throw new TypeError('_verify must be function');\n  }\n\n  passport.Strategy.call(this, options, verify);\n\n  this.name = options.name || 'wxwork';\n  this._client = options.client || 'wxwork';\n  this._verify = verify;\n  this._callbackURL = options.callbackURL;\n  this._lang = options.lang || 'en';\n  this._state = options.state;\n  this._scope = options.scope || 'snsapi_base';\n  this._passReqToCallback = options.passReqToCallback;\n}\n\nutil.inherits(WxworkStrategy, passport.Strategy);\n\nWxworkStrategy.prototype.getOAuth = function (options) {\n  const _config = options.getConfig();\n  return new OAuth(_config.corpid, _config.agentid);\n};\n\nWxworkStrategy.prototype.authenticate = function (req, options) {\n  if (!req._passport) {\n    return this.error(new Error('passport.initialize() middleware not in use'));\n  }\n\n  const self = this;\n\n  options = options || {};\n\n  // oauth\n  const _oauth = this.getOAuth(options);\n\n  // 校验完成信息\n  function verified(err, user, info) {\n    if (err) {\n      return self.error(err);\n    }\n    if (!user) {\n      return self.fail(info);\n    }\n    self.success(user, info);\n  }\n\n  // 获取code授权成功\n  if (req.url.indexOf('/callback') > -1) {\n    // 获取code,并校验相关参数的合法性\n    // No code only state --> User has rejected send details. (Fail authentication request).\n    if (req.query && req.query.state && !req.query.code) {\n      return self.fail(401);\n    }\n\n    // Documentation states that if user rejects userinfo only state will be sent without code\n    // In reality code equals \"authdeny\". Handle this case like the case above. (Fail authentication request).\n    if (req.query && req.query.code === 'authdeny') {\n      return self.fail(401);\n    }\n\n    const code = req.query.code;\n\n    try {\n      if (self._passReqToCallback) {\n        self._verify(req, code, verified);\n      } else {\n        self._verify(code, verified);\n      }\n    } catch (ex) {\n      return self.error(ex);\n    }\n  } else {\n    const state = options.state || self._state;\n    const callbackURL = options.callbackURL || self._callbackURL;\n    const scope = options.scope || self._scope;\n\n    const methodName = this._client === 'wxwork' ? 'getAuthorizeURL' : 'getAuthorizeURLForWebsite';\n    const location = _oauth[methodName](callbackURL, state, scope);\n\n    self.redirect(location, 302);\n  }\n};\n\nmodule.exports = WxworkStrategy;\n","module.exports = app => {\n  const routes = [\n    // message\n    { method: 'get', path: 'message/index', controller: 'message', meta: { auth: { enable: false } } },\n    { method: 'post', path: 'message/index', controller: 'message', meta: { auth: { enable: false } } },\n    { method: 'get', path: 'message/contacts', controller: 'message', meta: { auth: { enable: false } } },\n    { method: 'post', path: 'message/contacts', controller: 'message', meta: { auth: { enable: false } } },\n    // contacts\n    {\n      method: 'post',\n      path: 'contacts/sync',\n      controller: 'contacts',\n      meta: { right: { type: 'resource', module: 'a-settings', name: 'settings' } },\n    },\n    {\n      method: 'post',\n      path: 'contacts/syncStatus',\n      controller: 'contacts',\n      meta: { right: { type: 'resource', module: 'a-settings', name: 'settings' } },\n    },\n\n    // jsapi\n    { method: 'post', path: 'jssdk/jsconfig', controller: 'jssdk' },\n    { method: 'post', path: 'jssdk/jsconfigAgent', controller: 'jssdk' },\n\n    // authMini\n    { method: 'post', path: 'authMini/login', controller: 'authMini' },\n  ];\n  return routes;\n};\n","const WxworkHelperFn = require('../common/wxworkHelper.js');\n\nmodule.exports = app => {\n  class AuthMini extends app.Service {\n    async login({ scene, code }) {\n      if (!code) return this.ctx.throw(403);\n      const res = await this.ctx.bean.wxwork.app.mini[scene].code2Session(code);\n      // const res = { errcode: 0, userid: 'YangJian1', session_key: 'kJtdi6RF+Dv67QkbLlPGjw==' };\n      if (res.errcode) throw new Error(res.errmsg);\n      const session_key = res.session_key;\n      const memberId = res.userid;\n      // verify\n      const wxworkHelper = new (WxworkHelperFn(this.ctx))();\n      await wxworkHelper.verifyAuthUser({ scene: `wxworkmini${scene}`, memberId });\n      // save session_key, because ctx.state.user maybe changed\n      await this.ctx.bean.wxwork.mini[scene].saveSessionKey(session_key);\n      // echo\n      return await this.ctx.bean.auth.echo();\n    }\n  }\n\n  return AuthMini;\n};\n","const WxworkHelperFn = require('../common/wxworkHelper.js');\n\n// department\n\nconst __departmentFieldMap = [\n  ['departmentId', 'departmentParentId', 'departmentName', 'departmentNameEn', 'departmentOrder'],\n  ['id', 'parentid', 'name', 'name_en', 'order'],\n  ['number', 'number', 'string', 'string', 'number'],\n];\n\nconst __departmentFieldMap_XML = [\n  ['departmentId', 'departmentParentId', 'departmentName', 'departmentOrder'],\n  ['Id', 'ParentId', 'Name', 'Order'],\n  ['number', 'number', 'string', 'number'],\n];\n\n// member\n\nconst __memberFieldMap = [\n  [\n    'memberId',\n    'name',\n    'alias',\n    'mobile',\n    'department',\n    'sorting',\n    'position',\n    'gender',\n    'email',\n    'telephone',\n    'is_leader_in_dept',\n    'avatar',\n    'thumb_avatar',\n    'qr_code',\n    'status',\n    'extattr',\n    'external_profile',\n    'external_position',\n    'address',\n    'hide_mobile',\n    'english_name',\n    'open_userid',\n    'main_department',\n  ],\n  [\n    'userid',\n    'name',\n    'alias',\n    'mobile',\n    'department',\n    'order',\n    'position',\n    'gender',\n    'email',\n    'telephone',\n    'is_leader_in_dept',\n    'avatar',\n    'thumb_avatar',\n    'qr_code',\n    'status',\n    'extattr',\n    'external_profile',\n    'external_position',\n    'address',\n    'hide_mobile',\n    'english_name',\n    'open_userid',\n    'main_department',\n  ],\n  [\n    'string',\n    'string',\n    'string',\n    'string',\n    'array',\n    'array',\n    'string',\n    'number',\n    'string',\n    'string',\n    'array',\n    'string',\n    'string',\n    'string',\n    'number',\n    'json',\n    'json',\n    'string',\n    'string',\n    'number',\n    'string',\n    'string',\n    'number',\n  ],\n];\n\nconst __memberFieldMap_XML = [\n  [\n    'memberIdNew',\n    'memberId',\n    'name',\n    'alias',\n    'mobile',\n    'department',\n    'position',\n    'gender',\n    'email',\n    'telephone',\n    'is_leader_in_dept',\n    'avatar',\n    'status',\n    'extattr',\n    'address',\n  ],\n  [\n    'NewUserID',\n    'UserID',\n    'Name',\n    'Alias',\n    'Mobile',\n    'Department',\n    'Position',\n    'Gender',\n    'Email',\n    'Telephone',\n    'IsLeaderInDept',\n    'Avatar',\n    'Status',\n    'ExtAttr',\n    'Address',\n  ],\n  [\n    'string',\n    'string',\n    'string',\n    'string',\n    'string',\n    'string',\n    'string',\n    'number',\n    'string',\n    'string',\n    'string',\n    'string',\n    'number',\n    'json',\n    'string',\n  ],\n];\n\nmodule.exports = app => {\n  const moduleInfo = app.meta.mockUtil.parseInfoFromPackage(__dirname);\n  class Contacts extends app.Service {\n    async syncStatus() {\n      const departments = await this.ctx.bean.status.get('syncDepartments');\n      const members = await this.ctx.bean.status.get('syncMembers');\n      return { departments, members };\n    }\n\n    async queueSync({ type, progressId, userOp }) {\n      if (type === 'departments') {\n        await this._queueSyncDepartments({ progressId, userOp });\n      } else if (type === 'members') {\n        await this._queueSyncMembers({ progressId, userOp });\n      }\n    }\n\n    async queueChangeContact({ message }) {\n      const syncStatus = await this.syncStatus();\n      if (message.ChangeType.indexOf('_party') > -1) {\n        if (!syncStatus.departments) return this.ctx.throw(1006);\n        await this._queueChangeContactDepartment({ message });\n      } else if (message.ChangeType.indexOf('_user') > -1) {\n        if (!syncStatus.members) return this.ctx.throw(1007);\n        await this._queueChangeContactMember({ message });\n      }\n    }\n\n    async _queueChangeContactDepartment({ message }) {\n      // department\n      const department = {};\n      this._adjustFields(department, message, __departmentFieldMap_XML);\n      // do\n      if (message.ChangeType === 'create_party') {\n        // create\n        await this._createRoleAndDepartment({ department });\n        // build roles\n        this._roleBuild();\n      } else if (message.ChangeType === 'update_party') {\n        // update\n        await this._updateRoleAndDepartment({ localDepartment: null, department });\n      } else if (message.ChangeType === 'delete_party') {\n        await this._deleteRoleAndDepartment({ localDepartment: null, department });\n        // build roles\n        this._roleBuild();\n      }\n    }\n\n    async _queueChangeContactMember({ message }) {\n      const member = {};\n      this._adjustFields(member, message, __memberFieldMap_XML);\n      // do\n      if (message.ChangeType === 'create_user') {\n        // get member remotely\n        const res = await this.ctx.bean.wxwork.app.contacts.getUser(member.memberId);\n        if (res.errcode) {\n          throw new Error(res.errmsg);\n        }\n        // create\n        const _member = {};\n        this._adjustFields(_member, res, __memberFieldMap);\n        await this._createUserAndMember({ member: _member });\n      } else if (message.ChangeType === 'update_user') {\n        // check if memberId changed\n        if (member.memberIdNew) {\n          // upate memberId of member\n          await this.ctx.model.query('update aWxworkUser a set a.memberId=? where a.iid=? and a.memberId=?', [\n            member.memberIdNew,\n            this.ctx.instance.id,\n            member.memberId,\n          ]);\n          // upate profileId of auth\n          await this.ctx.model.query('update aAuth a set a.profileId=? where a.iid=? and a.profileId=?', [\n            `wxwork:${member.memberIdNew}`,\n            this.ctx.instance.id,\n            `wxwork:${member.memberId}`,\n          ]);\n        }\n        // get member remotely\n        const res = await this.ctx.bean.wxwork.app.contacts.getUser(member.memberIdNew || member.memberId);\n        if (res.errcode) {\n          throw new Error(res.errmsg);\n        }\n        // update\n        const _member = {};\n        this._adjustFields(_member, res, __memberFieldMap);\n        await this._updateUserAndMember({ localMember: null, member: _member });\n      } else if (message.ChangeType === 'delete_user') {\n        await this._deleteUserAndMember({ localMember: null, member });\n      }\n    }\n\n    // queue sync departments\n    async _queueSyncDepartments({ progressId, userOp }) {\n      // prepare context\n      const context = {\n        remoteDepartments: null,\n        progressId,\n        userOp,\n      };\n      try {\n        // progress\n        await this._progressPublish({ context, done: 0, text: `--- ${this.ctx.text('Sync Started')} ---` });\n        // remote departments\n        const res = await this.ctx.bean.wxwork.app.contacts.getDepartmentList();\n        if (res.errcode) {\n          throw new Error(res.errmsg);\n        }\n        context.remoteDepartments = res.department;\n        // progress\n        await this._progressPublish({\n          context,\n          done: 0,\n          text: `--- ${this.ctx.text('Department Count')}: ${context.remoteDepartments.length} ---`,\n        });\n        // local departments\n        context.localDepartments = await this.ctx.model.department.select();\n        context.localDepartmentsMap = {};\n        for (const localDepartment of context.localDepartments) {\n          localDepartment.__status = 0;\n          context.localDepartmentsMap[localDepartment.departmentId] = localDepartment;\n        }\n        // loop create/update\n        for (const remoteDepartment of context.remoteDepartments) {\n          await this._queueSyncDepartment({ context, remoteDepartment });\n        }\n        // delete __status===0\n        for (const departmentId in context.localDepartmentsMap) {\n          const localDepartment = context.localDepartmentsMap[departmentId];\n          if (localDepartment.__status === 0) {\n            await this._deleteRoleAndDepartment({ localDepartment, department: null });\n            // progress\n            await this._progressPublish({ context, done: 0, text: `- ${localDepartment.departmentName}` });\n          }\n        }\n        // build roles\n        this._roleBuild();\n        // progress done\n        await this.ctx.bean.status.set('syncDepartments', true);\n        await this._progressPublish({ context, done: 1, text: `--- ${this.ctx.text('Sync Completed')} ---` });\n      } catch (err) {\n        // progress error\n        await this._progressPublish({ context, done: -1, text: err.message });\n        // throw err\n        throw err;\n      }\n    }\n\n    // queue sync members\n    async _queueSyncMembers({ progressId, userOp }) {\n      // prepare context\n      const context = {\n        remoteMembers: null,\n        progressId,\n        userOp,\n      };\n      try {\n        // progress\n        await this._progressPublish({ context, done: 0, text: `--- ${this.ctx.text('Sync Started')} ---` });\n        // check departments syncStatus\n        const syncStatus = await this.syncStatus();\n        if (!syncStatus.departments) return this.ctx.throw(1006);\n        // remote members\n        const departmentRoot = await this.ctx.model.department.get({ departmentParentId: 0 });\n        if (!departmentRoot) return this.ctx.throw(1006);\n        const res = await this.ctx.bean.wxwork.app.contacts.getDepartmentUserList(departmentRoot.departmentId, 1);\n        if (res.errcode) {\n          throw new Error(res.errmsg);\n        }\n        context.remoteMembers = res.userlist;\n        // progress\n        await this._progressPublish({\n          context,\n          done: 0,\n          text: `--- ${this.ctx.text('Member Count')}: ${context.remoteMembers.length} ---`,\n        });\n        // local members\n        context.localMembers = await this.ctx.model.member.select();\n        context.localMembersMap = {};\n        for (const localMember of context.localMembers) {\n          localMember.__status = 0;\n          context.localMembersMap[localMember.memberId] = localMember;\n        }\n        // loop create/update\n        for (const remoteMember of context.remoteMembers) {\n          await this._queueSyncMember({ context, remoteMember });\n        }\n        // delete __status===0\n        for (const memberId in context.localMembersMap) {\n          const localMember = context.localMembersMap[memberId];\n          if (localMember.__status === 0) {\n            await this._deleteUserAndMember({ localMember, member: null });\n            // progress\n            await this._progressPublish({ context, done: 0, text: `- ${localMember.name}` });\n          }\n        }\n        // progress done\n        await this.ctx.bean.status.set('syncMembers', true);\n        await this._progressPublish({ context, done: 1, text: `--- ${this.ctx.text('Sync Completed')} ---` });\n      } catch (err) {\n        // progress error\n        await this._progressPublish({ context, done: -1, text: err.message });\n        // throw err\n        throw err;\n      }\n    }\n\n    async _progressPublish({ context, done, text }) {\n      const ioMessage = {\n        userIdTo: context.userOp.id,\n        messageFilter: context.progressId,\n        content: { done, text },\n      };\n      await this.ctx.bean.io.publish({\n        path: `/${moduleInfo.url}/progress/${context.progressId}`,\n        message: ioMessage,\n        messageClass: {\n          module: moduleInfo.relativeName,\n          messageClassName: 'progress',\n        },\n      });\n    }\n\n    async _queueSyncDepartment({ context, remoteDepartment }) {\n      const department = {};\n      this._adjustFields(department, remoteDepartment, __departmentFieldMap);\n      const departmentId = department.departmentId;\n      // check if local department exists\n      const localDepartment = context.localDepartmentsMap[departmentId];\n      // new department\n      if (!localDepartment) {\n        await this._createRoleAndDepartment({ department });\n        // progress\n        await this._progressPublish({ context, done: 0, text: `+ ${department.departmentName}` });\n        // done\n        return;\n      }\n      // update\n      await this._updateRoleAndDepartment({ localDepartment, department });\n      // progress: not prompt\n      // done\n      localDepartment.__status = 1; // handled\n      return;\n    }\n\n    async _queueSyncMember({ context, remoteMember }) {\n      const member = {};\n      this._adjustFields(member, remoteMember, __memberFieldMap);\n      const memberId = member.memberId;\n      // check if local member exists\n      const localMember = context.localMembersMap[memberId];\n      // new member\n      if (!localMember) {\n        await this._createUserAndMember({ member });\n        // progress\n        await this._progressPublish({ context, done: 0, text: `+ ${member.name}` });\n        // done\n        return;\n      }\n      // update\n      await this._updateUserAndMember({ localMember, member });\n      // progress: not prompt\n      // done\n      localMember.__status = 1; // handled\n      return;\n    }\n\n    async _deleteRoleAndDepartment({ localDepartment, department }) {\n      // localDepartment\n      if (!localDepartment) {\n        localDepartment = await this.ctx.model.department.get({ departmentId: department.departmentId });\n        if (!localDepartment) {\n          this.ctx.throw(1004, department.departmentId);\n        }\n      }\n      // delete role\n      await this.ctx.bean.role.delete({ roleId: localDepartment.roleId, force: true });\n      // delete department\n      await this.ctx.model.department.delete({ id: localDepartment.id });\n    }\n\n    async _deleteUserAndMember({ localMember, member }) {\n      // localMember\n      if (!localMember) {\n        localMember = await this.ctx.model.member.get({ memberId: member.memberId });\n        if (!localMember) {\n          this.ctx.throw(1005, member.memberId);\n        }\n      }\n      const userId = localMember.userId;\n      // delete user: including roles/auth\n      await this.ctx.bean.user.delete({ userId });\n      // delete member\n      await this.ctx.model.member.delete({ id: localMember.id });\n    }\n\n    async _updateRoleAndDepartment({ localDepartment, department }) {\n      // localDepartment\n      if (!localDepartment) {\n        localDepartment = await this.ctx.model.department.get({ departmentId: department.departmentId });\n        if (!localDepartment) {\n          this.ctx.throw(1004, department.departmentId);\n        }\n      }\n      // update role name\n      if (department.departmentName) {\n        await this.ctx.bean.role.save({\n          roleId: localDepartment.roleId,\n          data: { roleName: department.departmentName },\n        });\n      }\n      // update department\n      department.id = localDepartment.id;\n      await this.ctx.model.department.update(department);\n    }\n\n    async _updateUserRoles({ userId, departmentIdsOld, departmentIdsNew }) {\n      const departmentIdsAdd = [];\n      const departmentIdsDelete = [];\n      for (const departmentId of departmentIdsNew) {\n        if (departmentIdsOld.indexOf(departmentId) === -1) {\n          departmentIdsAdd.push(departmentId);\n        }\n      }\n      for (const departmentId of departmentIdsOld) {\n        if (departmentIdsNew.indexOf(departmentId) === -1) {\n          departmentIdsDelete.push(departmentId);\n        }\n      }\n      // add\n      await this._addUserRoles({ userId, departmentIds: departmentIdsAdd });\n      // delete\n      await this._deleteUserRoles({ userId, departmentIds: departmentIdsDelete });\n    }\n\n    async _updateUserAndMember({ localMember, member }) {\n      // localMember\n      if (!localMember) {\n        localMember = await this.ctx.model.member.get({ memberId: member.memberId });\n        if (!localMember) {\n          this.ctx.throw(1005, member.memberId);\n        }\n      }\n      const userId = localMember.userId;\n      // roles\n      if (member.department !== undefined && member.department !== localMember.department) {\n        await this._updateUserRoles({\n          userId,\n          departmentIdsOld: (localMember.department || '').split(','),\n          departmentIdsNew: (member.department || '').split(','),\n        });\n      }\n      // status\n      if (member.status !== undefined && member.status !== localMember.status) {\n        await this.ctx.bean.user.disable({ userId, disabled: member.status !== 1 });\n      }\n      // update member\n      member.id = localMember.id;\n      await this.ctx.model.member.update(member);\n    }\n\n    async _createRoleAndDepartment({ department }) {\n      // get parent role\n      const roleParent = await this._getRoleOfDepartment({ departmentId: department.departmentParentId });\n      if (!roleParent) {\n        this.ctx.throw(1003, department.departmentParentId);\n      }\n      // create current role\n      const roleIdCurrent = await this.ctx.bean.role.add({\n        roleName: department.departmentName,\n        catalog: 0, // update by sub role\n        sorting: department.departmentOrder,\n        roleIdParent: roleParent.id,\n      });\n      // force change parent role to catalog=1\n      await this.ctx.bean.role.save({\n        roleId: roleParent.id,\n        data: { catalog: 1 },\n      });\n      // creat department\n      department.roleId = roleIdCurrent;\n      const res = await this.ctx.model.department.insert(department);\n      return res.insertId;\n    }\n\n    // [1,2]\n    async _addUserRoles({ userId, departmentIds }) {\n      for (const departmentId of departmentIds) {\n        // get role of department\n        const roleCurrent = await this._getRoleOfDepartment({ departmentId });\n        if (!roleCurrent) {\n          this.ctx.throw(1003, departmentId);\n        }\n        // add user role\n        await this.ctx.bean.role.addUserRole({ userId, roleId: roleCurrent.id });\n      }\n    }\n\n    async _deleteUserRoles({ userId, departmentIds }) {\n      for (const departmentId of departmentIds) {\n        // get role of department\n        const roleCurrent = await this._getRoleOfDepartment({ departmentId });\n        if (!roleCurrent) {\n          this.ctx.throw(1003, departmentId);\n        }\n        // add user role\n        await this.ctx.bean.role.deleteUserRole({ userId, roleId: roleCurrent.id });\n      }\n    }\n\n    async _createUserAndMember({ member }) {\n      // 1. create user&auth\n      // verify auth user\n      const wxworkHelper = new (WxworkHelperFn(this.ctx))();\n      const verifyUser = await wxworkHelper.verifyAuthUser({ scene: 'wxwork', member, needLogin: false });\n      const userId = verifyUser.agent.id;\n\n      // 2. add user to role\n      if (member.department) {\n        await this._addUserRoles({ userId, departmentIds: member.department.split(',') });\n        // delete role:activated (need not)\n      }\n\n      // 3. status\n      if (member.status !== 1) {\n        await this.ctx.bean.user.disable({ userId, disabled: true });\n      }\n\n      // 4. create member\n      member.userId = userId;\n      const res = await this.ctx.model.member.insert(member);\n      const memberId = res.insertId;\n\n      // 5. send message: account migration\n      const sendLinkAccountMigration = await this.ctx.bean.settings.getInstance({\n        name: '/groupInfo/sendLinkAccountMigration',\n      });\n      if (sendLinkAccountMigration) {\n        await this._sendLinkAccountMigration({ userId });\n      }\n\n      // ok\n      return memberId;\n    }\n\n    async _sendLinkAccountMigration({ userId }) {\n      this.ctx.tail(async () => {\n        const content = {\n          userIds: [userId],\n          data: {\n            msgtype: 'textcard',\n            textcard: {\n              title: this.ctx.text('AccountMigration'),\n              description: this.ctx.text('AccountMigrationDesp'),\n              url: this.ctx.bean.base.getAbsoluteUrl('/#!/a/login/migrate'),\n            },\n          },\n        };\n        await this.ctx.bean.io.pushDirect({\n          content,\n          channel: { module: 'a-wxwork', name: 'app' },\n        });\n      });\n    }\n\n    // not create new role here\n    async _getRoleOfDepartment({ departmentId }) {\n      // role top\n      if (departmentId === 0) {\n        return await this._getRoleTop();\n      }\n      // department\n      const department = await this.ctx.model.department.get({ departmentId });\n      if (!department) return null;\n      return await this.ctx.bean.role.get({ id: department.roleId });\n    }\n\n    // get role top\n    async _getRoleTop() {\n      const roleContainer = await this.ctx.bean.role.parseRoleName({\n        roleName: this.ctx.config.sync.department.roleContainer,\n      });\n      const roleTop = await this.ctx.bean.role.get({\n        roleName: this.ctx.config.sync.department.roleTop,\n        roleIdParent: roleContainer.id,\n      });\n      if (roleTop) return roleTop;\n      // create role\n      const data = {\n        roleName: this.ctx.config.sync.department.roleTop,\n        catalog: 1,\n        sorting: 0,\n        roleIdParent: roleContainer.id,\n      };\n      data.id = await this.ctx.bean.role.add(data);\n      return data;\n    }\n\n    _adjustFields(itemDest, itemSrc, fieldMap) {\n      for (const index in fieldMap[1]) {\n        const field = fieldMap[1][index];\n        if (itemSrc[field] !== undefined) {\n          const fieldDest = fieldMap[0][index];\n          itemDest[fieldDest] = this._adjustFieldType(itemSrc[field], fieldMap[2][index]);\n        }\n      }\n    }\n    _adjustFieldType(value, type) {\n      if (type === 'number') return Number(value);\n      else if (type === 'string') return String(value);\n      else if (type === 'array') return value.join(',');\n      else if (type === 'json') return JSON.stringify(value);\n      return value;\n    }\n\n    _roleBuild() {\n      this.ctx.tail(async () => {\n        await this.ctx.bean.role.build();\n      });\n    }\n  }\n\n  return Contacts;\n};\n","module.exports = app => {\n  class JSSDK extends app.Service {\n    async jsconfig({ url }) {\n      // config\n      const config = this.ctx.config.account.wxwork;\n      const configAppSelfBuilt = config.apps.selfBuilt;\n      // params\n      const params = {\n        debug: configAppSelfBuilt.jssdk.debug,\n        jsApiList: configAppSelfBuilt.jssdk.jsApiList,\n        url,\n      };\n      return await this.ctx.bean.wxwork.app.selfBuilt.getJsConfig(params);\n    }\n\n    async jsconfigAgent({ url }) {\n      // config\n      const config = this.ctx.config.account.wxwork;\n      const configAppSelfBuilt = config.apps.selfBuilt;\n      // params\n      const params = {\n        agentid: configAppSelfBuilt.agentid,\n        jsApiList: configAppSelfBuilt.jssdkAgent.jsApiList,\n        url,\n      };\n      return await this.ctx.bean.wxwork.app.selfBuilt.getJsConfigAgent(params);\n    }\n  }\n\n  return JSSDK;\n};\n","module.exports = app => {\n  const moduleInfo = app.meta.mockUtil.parseInfoFromPackage(__dirname);\n  class Message extends app.Service {\n    async index({ message }) {\n      // config\n      const config = this.ctx.config.account.wxwork;\n      const configAppSelfBuilt = config.apps.selfBuilt;\n      // result\n      let result;\n      // event: subscribe\n      if (message.MsgType === 'event') {\n        if (message.Event === 'subscribe') {\n          // donothing，具体逻辑在通讯录回调通知中实现\n          return null;\n        } else if (message.Event === 'unsubscribe') {\n          // donothing，具体逻辑在通讯录回调通知中实现\n          return null;\n        }\n      }\n      // raise event\n      return await this.ctx.bean.event.invoke({\n        module: moduleInfo.relativeName,\n        name: 'wxworkMessage',\n        data: { message },\n        result,\n        next: async (context, next) => {\n          // default\n          if (context.result === undefined) {\n            if (message.MsgType !== 'event') {\n              context.result = {\n                ToUserName: message.FromUserName,\n                FromUserName: message.ToUserName,\n                CreateTime: new Date().getTime(),\n                MsgType: 'text',\n                Content: configAppSelfBuilt.message.reply.default,\n              };\n            }\n          }\n          await next();\n        },\n      });\n    }\n\n    async contacts({ message }) {\n      // queue\n      this.ctx.app.meta.queue.push({\n        locale: this.ctx.locale,\n        subdomain: this.ctx.subdomain,\n        module: moduleInfo.relativeName,\n        queueName: 'contacts',\n        data: {\n          queueAction: 'changeContact',\n          message,\n        },\n      });\n      // ok\n      return null;\n    }\n  }\n\n  return Message;\n};\n","const message = require('./service/message.js');\nconst contacts = require('./service/contacts.js');\nconst jssdk = require('./service/jssdk.js');\nconst authMini = require('./service/authMini.js');\n\nmodule.exports = app => {\n  const services = {\n    message,\n    contacts,\n    jssdk,\n    authMini,\n  };\n  return services;\n};\n","module.exports = require(\"require3\");","module.exports = require(\"crypto\");","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","","// startup\n// Load entry module and return exports\n// This entry module is referenced by other modules so it can't be inlined\nvar __webpack_exports__ = __webpack_require__(421);\n",""],"names":[],"sourceRoot":""}