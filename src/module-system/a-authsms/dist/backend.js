module.exports=function(e){var t={};function n(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(r,o,function(t){return e[t]}.bind(null,o));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=1)}([function(e,t){e.exports=require("require3")},function(e,t,n){const r=n(2),o=n(3),i=n(6),s=n(7);e.exports=function(e){const t=n(8)(e),a=n(12)(e),c=n(13)(e),u=n(17)(e),d=n(21)(e),l=n(22)(e);return{beans:t,routes:a,controllers:c,services:u,models:d,config:r,locales:o,errors:i,middlewares:s,meta:l}}},function(e,t){e.exports=function(e){const t={account:{url:{mobileVerify:"/a/authsms/mobileVerify"}}},n={module:"a-authsms",name:"captcha"};return t.captcha={scenes:{mobileVerify:n,signup:n,signin:n,signupCode:null}},t.sms={provider:{default:""},providers:{aliyun:{accessKeyId:"",secretAccessKey:"",endpoint:"https://dysmsapi.aliyuncs.com",apiVersion:"2017-05-25",signName:"",templates:{mobileVerify:"",signup:"",signin:""}}}},t}},function(e,t,n){e.exports={"en-us":n(4),"zh-cn":n(5)}},function(e,t){e.exports={smsProviderNonePrompt:"Please specify the sms provider",SMSCodeInvalid:"Verification code is invalid, please retrieve again",SMSCodeMismatch:"Mismatch Verification Code"}},function(e,t){e.exports={SMS:"短信",smsProviderNonePrompt:"请指定SMS Provider",SMSCodeInvalid:"认证码已失效，请重新获取",SMSCodeMismatch:"认证码不匹配","Element Exists":"元素已存在","Cannot Contain __":"不能包含__","SMS Verification":"短信认证","Authentication Failed":"认证失败","User is Disabled":"用户被禁用"}},function(e,t){e.exports={1001:"smsProviderNonePrompt",1002:"SMSCodeInvalid",1003:"SMSCodeMismatch",1004:"Authentication Failed",1005:"User is Disabled"}},function(e,t){e.exports={}},function(e,t,n){const r=n(9),o=n(10),i=n(11);e.exports=function(e){return{"event.accountMigration":{mode:"ctx",bean:r},"sms.provider.test":{mode:"ctx",bean:o},"sms.provider.aliyun":{mode:"ctx",bean:i}}}},function(e,t){function n(e,t,n,r,o,i,s){try{var a=e[i](s),c=a.value}catch(e){return void n(e)}a.done?t(c):Promise.resolve(c).then(r,o)}e.exports=function(e){const t=e.app.meta.mockUtil.parseInfoFromPackage(__dirname);return class{execute(r,o){return(i=function*(){const n=r.data,i=yield e.bean.user.getAuthProvider({module:t.relativeName,providerName:"authsms"}),s=e.model.module("a-base").auth,a=yield s.get({userId:n.userIdFrom,providerId:i.id});if(a){const t={id:n.userIdTo,mobile:a.profileId};yield e.bean.user.save({user:t})}yield o()},function(){var e=this,t=arguments;return new Promise((function(r,o){var s=i.apply(e,t);function a(e){n(s,r,o,a,c,"next",e)}function c(e){n(s,r,o,a,c,"throw",e)}a(void 0)}))})();var i}}}},function(e,t,n){function r(e,t,n,r,o,i,s){try{var a=e[i](s),c=a.value}catch(e){return void n(e)}a.done?t(c):Promise.resolve(c).then(r,o)}function o(e){return function(){var t=this,n=arguments;return new Promise((function(o,i){var s=e.apply(t,n);function a(e){r(s,o,i,a,c,"next",e)}function c(e){r(s,o,i,a,c,"throw",e)}a(void 0)}))}}const i=n(0),s=i("chalk"),a=i("boxen"),c={padding:1,margin:1,align:"center",borderColor:"yellow",borderStyle:"round"};e.exports=function(e){return class{sendCode(e){var t=this;return o((function*(){let{context:n}=e;const r=t.__prefix0(parseInt(1e4*Math.random()),4),o=s.keyword("cyan")("Test SMS Verification Code To: ")+s.keyword("yellow")(n.mobile)+s.keyword("orange")("\n"+r);return console.log("\n"+a(o,c)),{token:r}}))()}verify(t){return o((function*(){let{data:n,dataInput:r}=t;n||e.throw(1002),n.token!==r.token&&e.throw(1003)}))()}__prefix0(e,t){return(Array(t).join("0")+e).slice(-t)}}}},function(e,t,n){function r(e,t,n,r,o,i,s){try{var a=e[i](s),c=a.value}catch(e){return void n(e)}a.done?t(c):Promise.resolve(c).then(r,o)}function o(e){return function(){var t=this,n=arguments;return new Promise((function(o,i){var s=e.apply(t,n);function a(e){r(s,o,i,a,c,"next",e)}function c(e){r(s,o,i,a,c,"throw",e)}a(void 0)}))}}const i=n(0)("@alicloud/pop-core");e.exports=function(e){return class{sendCode(t){var n=this;return o((function*(){let{providerInstanceId:r,context:o,config:i}=t;const s=yield e.bean.captcha.getProviderInstance({providerInstanceId:r});s||e.throw(403);const a=n.__prefix0(parseInt(1e4*Math.random()),4),c={code:a},u={PhoneNumbers:o.mobile,SignName:i.signName,TemplateCode:i.templates[s.sceneName],TemplateParam:JSON.stringify(c)};return yield n.__sendSms({params:u,config:i}),{token:a}}))()}verify(t){return o((function*(){let{data:n,dataInput:r}=t;n||e.throw(1002),n.token!==r.token&&e.throw(1003)}))()}__sendSms(e){return o((function*(){let{params:t,config:n}=e;const r=new i.RPCClient({accessKeyId:n.accessKeyId,secretAccessKey:n.secretAccessKey,endpoint:n.endpoint,apiVersion:n.apiVersion});yield r.request("SendSms",t,{method:"POST"})}))()}__prefix0(e,t){return(Array(t).join("0")+e).slice(-t)}}}},function(e,t){e.exports=function(e){return[{method:"post",path:"version/update",controller:"version",middlewares:"inner"},{method:"post",path:"version/init",controller:"version",middlewares:"inner"},{method:"post",path:"version/test",controller:"version",middlewares:"test"},{method:"post",path:"captcha/sendCode",controller:"captcha"},{method:"post",path:"captcha/verify",controller:"captcha",middlewares:"inner"},{method:"post",path:"auth/signin",controller:"auth",middlewares:"captchaVerify",meta:{captchaVerify:{scene:{name:"signin"}}}},{method:"post",path:"auth/signup",controller:"auth",middlewares:"captchaVerify,validate",meta:{captchaVerify:{scenes:[{name:"signupCode",dataKey:"captchaCode",fieldKey:"tokenCode"},{name:"signup",dataKey:"captcha",fieldKey:"token"}]},validate:{validator:"signup"}}},{method:"post",path:"auth/mobileVerify",controller:"auth",middlewares:"validate,captchaVerify",meta:{validate:{validator:"mobileVerify"},captchaVerify:{scene:{name:"mobileVerify"}}}}]}},function(e,t,n){const r=n(14),o=n(15),i=n(16);e.exports=function(e){return{version:r,captcha:o,auth:i}}},function(e,t){function n(e,t,n,r,o,i,s){try{var a=e[i](s),c=a.value}catch(e){return void n(e)}a.done?t(c):Promise.resolve(c).then(r,o)}function r(e){return function(){var t=this,r=arguments;return new Promise((function(o,i){var s=e.apply(t,r);function a(e){n(s,o,i,a,c,"next",e)}function c(e){n(s,o,i,a,c,"throw",e)}a(void 0)}))}}e.exports=function(e){class t extends e.Controller{update(){var e=this;return r((function*(){yield e.service.version.update(e.ctx.request.body),e.ctx.success()}))()}init(){var e=this;return r((function*(){yield e.service.version.init(e.ctx.request.body),e.ctx.success()}))()}test(){var e=this;return r((function*(){yield e.service.version.test(e.ctx.request.body),e.ctx.success()}))()}}return t}},function(e,t){function n(e,t,n,r,o,i,s){try{var a=e[i](s),c=a.value}catch(e){return void n(e)}a.done?t(c):Promise.resolve(c).then(r,o)}function r(e){return function(){var t=this,r=arguments;return new Promise((function(o,i){var s=e.apply(t,r);function a(e){n(s,o,i,a,c,"next",e)}function c(e){n(s,o,i,a,c,"throw",e)}a(void 0)}))}}e.exports=function(e){class t extends e.Controller{sendCode(){var e=this;return r((function*(){yield e.ctx.service.captcha.sendCode({providerInstanceId:e.ctx.request.body.providerInstanceId,context:e.ctx.request.body.context}),e.ctx.success()}))()}verify(){var e=this;return r((function*(){const{providerInstanceId:t,context:n,data:r,dataInput:o}=e.ctx.request.body;yield e.ctx.service.captcha.verify({providerInstanceId:t,context:n,data:r,dataInput:o}),e.ctx.success()}))()}}return t}},function(e,t){function n(e,t,n,r,o,i,s){try{var a=e[i](s),c=a.value}catch(e){return void n(e)}a.done?t(c):Promise.resolve(c).then(r,o)}function r(e){return function(){var t=this,r=arguments;return new Promise((function(o,i){var s=e.apply(t,r);function a(e){n(s,o,i,a,c,"next",e)}function c(e){n(s,o,i,a,c,"throw",e)}a(void 0)}))}}e.exports=function(e){class t extends e.Controller{signin(){var e=this;return r((function*(){const t=e.ctx.request.body.data,n=e.ctx.request.body.state,r=yield e.service.auth.signin({data:t,state:n});e.ctx.success(r)}))()}signup(){var e=this;return r((function*(){const{userName:t,realName:n,mobile:r}=e.ctx.request.body.data,o=e.ctx.request.body.state,i=yield e.service.auth.signup({user:e.ctx.state.user.agent,state:o,userName:t,realName:n,mobile:r});e.ctx.success(i)}))()}mobileVerify(){var e=this;return r((function*(){const{mobile:t}=e.ctx.request.body.data,n=yield e.service.auth.mobileVerify({user:e.ctx.state.user.agent,mobile:t});e.ctx.success(n)}))()}}return t}},function(e,t,n){const r=n(18),o=n(19),i=n(20);e.exports=function(e){return{version:r,captcha:o,auth:i}}},function(e,t){function n(e,t,n,r,o,i,s){try{var a=e[i](s),c=a.value}catch(e){return void n(e)}a.done?t(c):Promise.resolve(c).then(r,o)}function r(e){return function(){var t=this,r=arguments;return new Promise((function(o,i){var s=e.apply(t,r);function a(e){n(s,o,i,a,c,"next",e)}function c(e){n(s,o,i,a,c,"throw",e)}a(void 0)}))}}e.exports=function(e){class t extends e.Service{update(e){return r((function*(){}))()}init(e){return r((function*(){}))()}test(){return r((function*(){}))()}}return t}},function(e,t,n){function r(e,t,n,r,o,i,s){try{var a=e[i](s),c=a.value}catch(e){return void n(e)}a.done?t(c):Promise.resolve(c).then(r,o)}function o(e){return function(){var t=this,n=arguments;return new Promise((function(o,i){var s=e.apply(t,n);function a(e){r(s,o,i,a,c,"next",e)}function c(e){r(s,o,i,a,c,"throw",e)}a(void 0)}))}}const i=n(0),s=i("chalk"),a=i("boxen"),c={padding:1,margin:1,align:"center",borderColor:"yellow",borderStyle:"round"};e.exports=function(e){const t=e.meta.mockUtil.parseInfoFromPackage(__dirname);class n extends e.Service{sendCode(e){var t=this;return o((function*(){let{providerInstanceId:n,context:r}=e;const{provider:o,config:i}=t.__createSMSProvider(),s=yield o.sendCode({providerInstanceId:n,context:r,config:i});yield t.ctx.bean.captcha.update({providerInstanceId:n,data:s,context:r})}))()}verify(e){var t=this;return o((function*(){let{providerInstanceId:n,context:r,data:o,dataInput:i}=e;const{provider:s,config:a}=t.__createSMSProvider();yield s.verify({providerInstanceId:n,context:r,data:o,dataInput:i,config:a})}))()}__createSMSProvider(){let n=this.ctx.config.sms.provider.default;if(n||!e.meta.isTest&&!e.meta.isLocal||(n="test"),!n){const e=s.keyword("orange")(this.ctx.text("smsProviderNonePrompt"));console.log("\n"+a(e,c)),this.ctx.throw(1001)}return{provider:this.ctx.bean._getBean(t.relativeName,"sms.provider.".concat(n)),config:this.ctx.config.sms.providers[n]}}}return n}},function(e,t){function n(e,t,n,r,o,i,s){try{var a=e[i](s),c=a.value}catch(e){return void n(e)}a.done?t(c):Promise.resolve(c).then(r,o)}function r(e){return function(){var t=this,r=arguments;return new Promise((function(o,i){var s=e.apply(t,r);function a(e){n(s,o,i,a,c,"next",e)}function c(e){n(s,o,i,a,c,"throw",e)}a(void 0)}))}}e.exports=function(e){const t=e.meta.mockUtil.parseInfoFromPackage(__dirname);class n extends e.Service{signup(e){var n=this;return r((function*(){let{user:r,state:o="login",userName:i,realName:s,mobile:a}=e;const c={module:t.relativeName,provider:"authsms",profileId:a,maxAge:0,profile:{mobile:a,rememberMe:!1}},u=yield n.ctx.bean.user.verify({state:o,profileUser:c});u||n.ctx.throw(403);const d=u.agent.id,l={id:d};return i&&("login"===o||!r.userName||r.userName.indexOf("__")>-1)&&(l.userName=i),s&&(l.realName=s),yield n.ctx.bean.user.save({user:l}),yield n.ctx.bean.user.setActivated({user:{id:d,mobile:a,mobileVerified:1}}),yield n.ctx.login(u),u}))()}signin(e){var t=this;return r((function*(){let{data:n,state:r="login"}=e;return yield t.ctx.performAction({method:"post",url:"passport/a-authsms/authsms?state=".concat(r),body:{data:n}})}))()}mobileVerify(e){var t=this;return r((function*(){let{user:n,mobile:r}=e;yield t.signup({user:n,state:"associate",userName:null,realName:null,mobile:r})}))()}}return n}},function(e,t){e.exports=function(e){return{}}},function(e,t,n){e.exports=function(e){const t=n(23)(e),r=n(28)(e),o=n(29)(e);return{auth:t,validation:{validators:{signup:{schemas:"signup"},signin:{schemas:"signin"},mobileVerify:{schemas:"mobileVerify"}},keywords:{"x-exists":r.exists},schemas:{signup:o.signup,signin:o.signin,mobileVerify:o.mobileVerify}},event:{implementations:{"a-base:accountMigration":"accountMigration"}}}}},function(e,t,n){function r(e,t,n,r,o,i,s){try{var a=e[i](s),c=a.value}catch(e){return void n(e)}a.done?t(c):Promise.resolve(c).then(r,o)}function o(e){return function(){var t=this,n=arguments;return new Promise((function(o,i){var s=e.apply(t,n);function a(e){r(s,o,i,a,c,"next",e)}function c(e){r(s,o,i,a,c,"throw",e)}a(void 0)}))}}const i=n(24);e.exports=function(e){const t=e.meta.mockUtil.parseInfoFromPackage(__dirname),n=t.name;function r(){return(r=o((function*(e,r){const{mobile:o,rememberMe:i}=r.data;yield e.bean.validation.validate({validator:"signin",data:r.data});const s=yield e.bean.user.exists({mobile:o});return s?s.disabled?e.throw(1005):{module:t.relativeName,provider:n,profileId:o,maxAge:i?null:0,authShouldExists:!0,profile:{mobile:o,rememberMe:i}}:e.throw(1004)}))).apply(this,arguments)}return{providers:{[n]:{meta:{title:"SMS",inline:!0,mode:"direct",component:"signin"},config:{},handler:function(e){return{strategy:i,callback:function(t,n,o){(function(e,t){return r.apply(this,arguments)})(t.ctx,n).then((function(n){e.passport.doVerify(t,n,o)})).catch((function(e){o(e)}))}}}}}}}},function(e,t,n){const r=n(25);function o(e,t){if("function"==typeof e&&(t=e,e={}),!t)throw new TypeError("LocalStrategy requires a verify callback");r.Strategy.call(this),this.name="sms",this._verify=t,this._passReqToCallback=e.passReqToCallback}n(27).inherits(o,r.Strategy),o.prototype.authenticate=function(e){const t=this;if("GET"===e.method)return t.error(e.ctx.parseFail(403));function n(n,r,o){return n?t.error(n):r?(e.ctx.success(r),void t.success(r,o)):t.fail(o)}try{t._passReqToCallback?this._verify(e,e.body,n):this._verify(e.body,n)}catch(e){return t.error(e)}},e.exports=o},function(e,t,n){var r=n(26);(e.exports=r).Strategy=r},function(e,t){function n(){}n.prototype.authenticate=function(e,t){throw new Error("Strategy#authenticate must be overridden by subclass")},e.exports=n},function(e,t){e.exports=require("util")},function(e,t){function n(e,t,n,r,o,i,s){try{var a=e[i](s),c=a.value}catch(e){return void n(e)}a.done?t(c):Promise.resolve(c).then(r,o)}e.exports=function(e){const t={};return t.exists={async:!0,type:"string",errors:!0,compile:function(){return function(){var t,r=(t=function*(t,n,r,o){const i=this,s=yield i.bean.user.exists({[o]:t});if(s&&s.id!==i.state.user.agent.id){const t=[{keyword:"x-exists",params:[],message:i.text("Element Exists")}];throw new e.meta.ajv.ValidationError(t)}if(!s&&t.indexOf("__")>-1){const t=[{keyword:"x-exists",params:[],message:i.text("Cannot Contain __")}];throw new e.meta.ajv.ValidationError(t)}return!0},function(){var e=this,r=arguments;return new Promise((function(o,i){var s=t.apply(e,r);function a(e){n(s,o,i,a,c,"next",e)}function c(e){n(s,o,i,a,c,"throw",e)}a(void 0)}))});return function(e,t,n,o){return r.apply(this,arguments)}}()}},t}},function(e,t){e.exports=function(e){const t={signup:{type:"object",properties:{userName:{type:"string",ebType:"text",ebTitle:"Username",notEmpty:!0,"x-exists":!0},realName:{type:"string",ebType:"text",ebTitle:"Realname",notEmpty:!0},mobile:{type:"string",ebType:"text",ebInputType:"tel",ebTitle:"Phone Number",notEmpty:!0,"x-exists":!0}}},signin:{type:"object",properties:{mobile:{type:"string",ebType:"text",ebInputType:"tel",ebTitle:"Phone Number",notEmpty:!0},rememberMe:{type:"boolean",ebType:"toggle",ebTitle:"Remember Me"}}},mobileVerify:{type:"object",properties:{userName:{type:"string",ebType:"text",ebTitle:"Username",ebReadOnly:!0},mobile:{type:"string",ebType:"text",ebInputType:"tel",ebTitle:"Phone Number",notEmpty:!0,"x-exists":!0}}}};return t}}]);