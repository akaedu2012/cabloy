module.exports=(()=>{var e={241:(e,t,n)=>{function r(e,t,n,r,o,i,a){try{var s=e[i](a),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,o)}const o=n(718),i=o("chalk"),a=o("boxen"),s={padding:1,margin:1,align:"center",borderColor:"yellow",borderStyle:"round"};e.exports=function(e){const t=e.app.meta.mockUtil.parseInfoFromPackage(__dirname);return class{verify(e){var t,n=this;return(t=function*(){const{providerInstanceId:t,context:r,data:o,dataInput:i}=e,{provider:a,config:s}=n.__createSMSProvider();yield a.verify({providerInstanceId:t,context:r,data:o,dataInput:i,config:s})},function(){var e=this,n=arguments;return new Promise((function(o,i){var a=t.apply(e,n);function s(e){r(a,o,i,s,c,"next",e)}function c(e){r(a,o,i,s,c,"throw",e)}s(void 0)}))})()}__createSMSProvider(n){const r=e.config.module(t.relativeName);let o=n&&n.providerName;if(!o&&(o=r.sms.provider.default,o||!e.app.meta.isTest&&!e.app.meta.isLocal||(o="test"),!o)){const n=i.keyword("orange")(e.text("smsProviderNonePrompt"));console.log("\n"+a(n,s)),e.throw.module(t.relativeName,1001)}return{provider:e.bean._getBean(t.relativeName,"sms.provider.".concat(o)),config:r.sms.providers[o]}}}}},987:e=>{function t(e,t,n,r,o,i,a){try{var s=e[i](a),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,o)}e.exports=function(e){const n=e.app.meta.mockUtil.parseInfoFromPackage(__dirname);return class{execute(r,o){return(i=function*(){const t=r.data,i=yield e.bean.user.getAuthProvider({module:n.relativeName,providerName:"authsms"}),a=e.model.module("a-base").auth,s=yield a.get({userId:t.userIdFrom,providerId:i.id});if(s){const n={id:t.userIdTo,mobile:s.profileId};yield e.bean.user.save({user:n})}yield o()},function(){var e=this,n=arguments;return new Promise((function(r,o){var a=i.apply(e,n);function s(e){t(a,r,o,s,c,"next",e)}function c(e){t(a,r,o,s,c,"throw",e)}s(void 0)}))})();var i}}}},654:(e,t,n)=>{function r(e,t,n,r,o,i,a){try{var s=e[i](a),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,o)}function o(e){return function(){var t=this,n=arguments;return new Promise((function(o,i){var a=e.apply(t,n);function s(e){r(a,o,i,s,c,"next",e)}function c(e){r(a,o,i,s,c,"throw",e)}s(void 0)}))}}const i=n(718)("@alicloud/pop-core");e.exports=function(e){const t=e.app.meta.mockUtil.parseInfoFromPackage(__dirname);return class{sendCode(t){var n=this;return o((function*(){let{providerInstanceId:r,context:o,config:i}=t;const a=yield e.bean.captcha.getProviderInstance({providerInstanceId:r});a||e.throw(403);const s=n.__prefix0(parseInt(1e4*Math.random()),4),c={code:s},u={PhoneNumbers:o.mobile,SignName:i.signName,TemplateCode:i.templates[a.sceneName],TemplateParam:JSON.stringify(c)};return yield n.__sendSms({params:u,config:i}),{token:s}}))()}verify(n){return o((function*(){let{data:r,dataInput:o}=n;r||e.throw.module(t.relativeName,1002),r.token!==o.token&&e.throw.module(t.relativeName,1003)}))()}__sendSms(e){return o((function*(){let{params:t,config:n}=e;const r=new i.RPCClient({accessKeyId:n.accessKeyId,secretAccessKey:n.secretAccessKey,endpoint:n.endpoint,apiVersion:n.apiVersion});yield r.request("SendSms",t,{method:"POST"})}))()}__prefix0(e,t){return(Array(t).join("0")+e).slice(-t)}}}},428:(e,t,n)=>{function r(e,t,n,r,o,i,a){try{var s=e[i](a),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,o)}function o(e){return function(){var t=this,n=arguments;return new Promise((function(o,i){var a=e.apply(t,n);function s(e){r(a,o,i,s,c,"next",e)}function c(e){r(a,o,i,s,c,"throw",e)}s(void 0)}))}}const i=n(718),a=i("chalk"),s=i("boxen"),c={padding:1,margin:1,align:"center",borderColor:"yellow",borderStyle:"round"};e.exports=function(e){const t=e.app.meta.mockUtil.parseInfoFromPackage(__dirname);return class{sendCode(e){var t=this;return o((function*(){let{context:n}=e;const r=t.__prefix0(parseInt(1e4*Math.random()),4),o=a.keyword("cyan")("Test SMS Verification Code To: ")+a.keyword("yellow")(n.mobile)+a.keyword("orange")("\n"+r);return console.log("\n"+s(o,c)),{token:r}}))()}verify(n){return o((function*(){let{data:r,dataInput:o}=n;r||e.throw.module(t.relativeName,1002),r.token!==o.token&&e.throw.module(t.relativeName,1003)}))()}__prefix0(e,t){return(Array(t).join("0")+e).slice(-t)}}}},313:(e,t,n)=>{const r=n(987),o=n(428),i=n(654),a=n(241);e.exports=function(e){return{"event.accountMigration":{mode:"ctx",bean:r},"sms.provider.test":{mode:"ctx",bean:o},"sms.provider.aliyun":{mode:"ctx",bean:i},"captcha.provider.captcha":{mode:"ctx",bean:a}}}},817:e=>{e.exports=function(e){const t={account:{url:{mobileVerify:"/a/authsms/mobileVerify"}}},n={module:"a-authsms",name:"captcha"};return t.captcha={scenes:{mobileVerify:n,signup:n,signin:n,signupCode:null}},t.sms={provider:{default:""},providers:{aliyun:{accessKeyId:"",secretAccessKey:"",endpoint:"https://dysmsapi.aliyuncs.com",apiVersion:"2017-05-25",signName:"",templates:{mobileVerify:"",signup:"",signin:""}}}},t}},971:e=>{e.exports={1001:"smsProviderNonePrompt",1002:"SMSCodeInvalid",1003:"SMSCodeMismatch",1004:"Authentication Failed",1005:"User is Disabled"}},724:e=>{e.exports={smsProviderNonePrompt:"Please specify the sms provider",SMSCodeInvalid:"Verification code is invalid, please retrieve again",SMSCodeMismatch:"Mismatch Verification Code"}},995:e=>{e.exports={SMS:"短信",smsProviderNonePrompt:"请指定SMS Provider",SMSCodeInvalid:"认证码已失效，请重新获取",SMSCodeMismatch:"认证码不匹配","Element Exists":"元素已存在","Cannot Contain __":"不能包含__","SMS Verification":"短信认证","Authentication Failed":"认证失败","User is Disabled":"用户被禁用"}},266:(e,t,n)=>{e.exports={"en-us":n(724),"zh-cn":n(995)}},480:(e,t,n)=>{function r(e,t,n,r,o,i,a){try{var s=e[i](a),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,o)}function o(e){return function(){var t=this,n=arguments;return new Promise((function(o,i){var a=e.apply(t,n);function s(e){r(a,o,i,s,c,"next",e)}function c(e){r(a,o,i,s,c,"throw",e)}s(void 0)}))}}const i=n(752);e.exports=function(e){const t=e.meta.mockUtil.parseInfoFromPackage(__dirname),n=t.name;function r(){return(r=o((function*(e,r){const{mobile:o,rememberMe:i}=r.data;yield e.bean.validation.validate({validator:"signin",data:r.data});const a=yield e.bean.user.exists({mobile:o});return a?a.disabled?e.throw(1005):{module:t.relativeName,provider:n,profileId:o,maxAge:i?null:0,authShouldExists:!0,profile:{mobile:o,rememberMe:i}}:e.throw(1004)}))).apply(this,arguments)}return{providers:{[n]:{meta:{title:"SMS",inline:!0,mode:"direct",component:"signin"},config:{},handler:function(e){return{strategy:i,callback:function(t,n,o){(function(e,t){return r.apply(this,arguments)})(t.ctx,n).then((function(n){e.passport.doVerify(t,n,o)})).catch((function(e){o(e)}))}}}}}}}},752:(e,t,n)=>{const r=n(581);function o(e,t){if("function"==typeof e&&(t=e,e={}),!t)throw new TypeError("LocalStrategy requires a verify callback");r.Strategy.call(this),this.name="sms",this._verify=t,this._passReqToCallback=e.passReqToCallback}n(669).inherits(o,r.Strategy),o.prototype.authenticate=function(e){const t=this;if("GET"===e.method)return t.error(e.ctx.parseFail(403));function n(n,r,o){return n?t.error(n):r?(e.ctx.success(r),void t.success(r,o)):t.fail(o)}try{t._passReqToCallback?this._verify(e,e.body,n):this._verify(e.body,n)}catch(e){return t.error(e)}},e.exports=o},623:e=>{function t(e,t,n,r,o,i,a){try{var s=e[i](a),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,o)}e.exports=function(e){const n={};return n.exists={async:!0,type:"string",errors:!0,compile:function(){return function(){var n,r=(n=function*(t,n,r,o){const i=this,a=yield i.bean.user.exists({[o]:t});if(a&&a.id!==i.state.user.agent.id){const t=[{keyword:"x-exists",params:[],message:i.text("Element Exists")}];throw new e.meta.ajv.ValidationError(t)}if(!a&&t.indexOf("__")>-1){const t=[{keyword:"x-exists",params:[],message:i.text("Cannot Contain __")}];throw new e.meta.ajv.ValidationError(t)}return!0},function(){var e=this,r=arguments;return new Promise((function(o,i){var a=n.apply(e,r);function s(e){t(a,o,i,s,c,"next",e)}function c(e){t(a,o,i,s,c,"throw",e)}s(void 0)}))});return function(e,t,n,o){return r.apply(this,arguments)}}()}},n}},326:e=>{e.exports=function(e){return{signup:{type:"object",properties:{userName:{type:"string",ebType:"text",ebTitle:"Username",notEmpty:!0,"x-exists":!0},realName:{type:"string",ebType:"text",ebTitle:"Realname",notEmpty:!0},mobile:{type:"string",ebType:"text",ebInputType:"tel",ebTitle:"Phone Number",notEmpty:!0,"x-exists":!0}}},signin:{type:"object",properties:{mobile:{type:"string",ebType:"text",ebInputType:"tel",ebTitle:"Phone Number",notEmpty:!0},rememberMe:{type:"boolean",ebType:"toggle",ebTitle:"Remember Me"}}},mobileVerify:{type:"object",properties:{userName:{type:"string",ebType:"text",ebTitle:"Username",ebReadOnly:!0},mobile:{type:"string",ebType:"text",ebInputType:"tel",ebTitle:"Phone Number",notEmpty:!0,"x-exists":!0}}}}}},954:e=>{function t(e,t,n,r,o,i,a){try{var s=e[i](a),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,o)}function n(e){return function(){var n=this,r=arguments;return new Promise((function(o,i){var a=e.apply(n,r);function s(e){t(a,o,i,s,c,"next",e)}function c(e){t(a,o,i,s,c,"throw",e)}s(void 0)}))}}e.exports=function(e){class t extends e.Controller{signin(){var e=this;return n((function*(){const t=e.ctx.request.body.data,n=e.ctx.request.body.state,r=yield e.service.auth.signin({data:t,state:n});e.ctx.success(r)}))()}signup(){var e=this;return n((function*(){const{userName:t,realName:n,mobile:r}=e.ctx.request.body.data,o=e.ctx.request.body.state,i=yield e.service.auth.signup({user:e.ctx.state.user.agent,state:o,userName:t,realName:n,mobile:r});e.ctx.success(i)}))()}mobileVerify(){var e=this;return n((function*(){const{mobile:t}=e.ctx.request.body.data,n=yield e.service.auth.mobileVerify({user:e.ctx.state.user.agent,mobile:t});e.ctx.success(n)}))()}}return t}},167:e=>{function t(e,t,n,r,o,i,a){try{var s=e[i](a),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,o)}e.exports=function(e){class n extends e.Controller{sendCode(){var e,n=this;return(e=function*(){yield n.ctx.service.captcha.sendCode({providerInstanceId:n.ctx.request.body.providerInstanceId,context:n.ctx.request.body.context}),n.ctx.success()},function(){var n=this,r=arguments;return new Promise((function(o,i){var a=e.apply(n,r);function s(e){t(a,o,i,s,c,"next",e)}function c(e){t(a,o,i,s,c,"throw",e)}s(void 0)}))})()}}return n}},691:(e,t,n)=>{const r=n(167),o=n(954);e.exports=function(e){return{captcha:r,auth:o}}},312:(e,t,n)=>{const r=n(817),o=n(266),i=n(971);e.exports=function(e){const t=n(313)(e),a=n(788)(e),s=n(691)(e),c=n(481)(e),u=n(700)(e),d=n(730)(e);return{beans:t,routes:a,controllers:s,services:c,models:u,config:r,locales:o,errors:i,meta:d}}},730:(e,t,n)=>{e.exports=function(e){const t=n(480)(e),r=n(623)(e),o=n(326)(e);return{auth:t,validation:{validators:{signup:{schemas:"signup"},signin:{schemas:"signin"},mobileVerify:{schemas:"mobileVerify"}},keywords:{"x-exists":r.exists},schemas:{signup:o.signup,signin:o.signin,mobileVerify:o.mobileVerify}},event:{implementations:{"a-base:accountMigration":"accountMigration"}}}}},700:e=>{e.exports=function(e){return{}}},788:e=>{e.exports=function(e){return[{method:"post",path:"captcha/sendCode",controller:"captcha"},{method:"post",path:"auth/signin",controller:"auth",middlewares:"captchaVerify",meta:{captchaVerify:{scene:{name:"signin"}}}},{method:"post",path:"auth/signup",controller:"auth",middlewares:"captchaVerify,validate",meta:{captchaVerify:{scenes:[{name:"signupCode",dataKey:"captchaCode",fieldKey:"tokenCode"},{name:"signup",dataKey:"captcha",fieldKey:"token"}]},validate:{validator:"signup"}}},{method:"post",path:"auth/mobileVerify",controller:"auth",middlewares:"validate,captchaVerify",meta:{validate:{validator:"mobileVerify"},captchaVerify:{scene:{name:"mobileVerify"}}}}]}},574:e=>{function t(e,t,n,r,o,i,a){try{var s=e[i](a),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,o)}function n(e){return function(){var n=this,r=arguments;return new Promise((function(o,i){var a=e.apply(n,r);function s(e){t(a,o,i,s,c,"next",e)}function c(e){t(a,o,i,s,c,"throw",e)}s(void 0)}))}}e.exports=function(e){const t=e.meta.mockUtil.parseInfoFromPackage(__dirname);class r extends e.Service{signup(e){var r=this;return n((function*(){let{user:n,state:o="login",userName:i,realName:a,mobile:s}=e;const c={module:t.relativeName,provider:"authsms",profileId:s,maxAge:0,profile:{mobile:s,rememberMe:!1}},u=yield r.ctx.bean.user.verify({state:o,profileUser:c});u||r.ctx.throw(403);const d=u.agent.id,l={id:d};return i&&("login"===o||!n.userName||n.userName.indexOf("__")>-1)&&(l.userName=i),a&&(l.realName=a),yield r.ctx.bean.user.save({user:l}),yield r.ctx.bean.user.setActivated({user:{id:d,mobile:s,mobileVerified:1}}),yield r.ctx.login(u),u}))()}signin(e){var t=this;return n((function*(){let{data:n,state:r="login"}=e;return yield t.ctx.performAction({method:"post",url:"passport/a-authsms/authsms?state=".concat(r),body:{data:n}})}))()}mobileVerify(e){var t=this;return n((function*(){let{user:n,mobile:r}=e;yield t.signup({user:n,state:"associate",userName:null,realName:null,mobile:r})}))()}}return r}},723:e=>{function t(e,t,n,r,o,i,a){try{var s=e[i](a),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,o)}e.exports=function(e){const n=e.meta.mockUtil.parseInfoFromPackage(__dirname);class r extends e.Service{sendCode(e){var r,o=this;return(r=function*(){let{providerInstanceId:t,context:r}=e;const i=o.ctx.bean._getBean("".concat(n.relativeName,".captcha.provider.captcha")),{provider:a,config:s}=i.__createSMSProvider(),c=yield a.sendCode({providerInstanceId:t,context:r,config:s});yield o.ctx.bean.captcha.update({providerInstanceId:t,data:c,context:r})},function(){var e=this,n=arguments;return new Promise((function(o,i){var a=r.apply(e,n);function s(e){t(a,o,i,s,c,"next",e)}function c(e){t(a,o,i,s,c,"throw",e)}s(void 0)}))})()}}return r}},481:(e,t,n)=>{const r=n(723),o=n(574);e.exports=function(e){return{captcha:r,auth:o}}},581:(e,t,n)=>{var r=n(703);(e.exports=r).Strategy=r},703:e=>{function t(){}t.prototype.authenticate=function(e,t){throw new Error("Strategy#authenticate must be overridden by subclass")},e.exports=t},718:e=>{"use strict";e.exports=require("require3")},669:e=>{"use strict";e.exports=require("util")}},t={};return function n(r){if(t[r])return t[r].exports;var o=t[r]={exports:{}};return e[r](o,o.exports,n),o.exports}(312)})();